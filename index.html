<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ResidentHub - Student Accommodation (Supabase)</title>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700;800&family=Nunito+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- Supabase client library -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    /* (Keep all existing CSS exactly as before) */
    :root{--pri:#1B4332;--pri-l:#2D6A4F;--pri-d:#081C15;--acc:#E6A817;--acc-l:#F5CB5C;--acc-d:#B8860B;--err:#DC2626;--err-l:#FEE2E2;--suc:#059669;--suc-l:#D1FAE5;--warn:#D97706;--warn-l:#FEF3C7;--bg:#F8F6F0;--bg2:#EFEDE6;--bg3:#E5E2DA;--card:#FFFFFF;--card2:#F5F3ED;--txt:#1A1A1A;--txt2:#4A4A4A;--txt3:#7A7A7A;--brd:#D4D0C8;--shd:0 2px 12px rgba(0,0,0,.08);--shd2:0 4px 24px rgba(0,0,0,.12);--rad:10px;--rad2:16px;--trans:all .25s ease}
    html.dark{--pri:#4ADE80;--pri-l:#6EE7A0;--pri-d:#22C55E;--acc:#F5CB5C;--acc-l:#FDE68A;--acc-d:#E6A817;--bg:#0F1117;--bg2:#1A1D27;--bg3:#252833;--card:#1E2130;--card2:#252839;--txt:#E8E8E8;--txt2:#B0B0B0;--txt3:#787878;--brd:#333648;--shd:0 2px 12px rgba(0,0,0,.3);--shd2:0 4px 24px rgba(0,0,0,.4)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Nunito Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden;font-size:15px}
    h1,h2,h3,h4,h5{font-family:'Bricolage Grotesque',sans-serif;color:var(--txt);font-weight:700}
    .topbar{background:var(--pri-d);color:#fff;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    html.dark .topbar{background:#161822;border-bottom:1px solid var(--brd)}
    .topbar .logo{font-family:'Bricolage Grotesque',sans-serif;font-size:1.3rem;font-weight:800;display:flex;align-items:center;gap:8px}
    .topbar .logo i{color:var(--acc);font-size:1.1rem}
    .topbar .mode-tabs{display:flex;gap:4px;background:rgba(255,255,255,.1);border-radius:8px;padding:3px}
    .topbar .mode-tab{padding:6px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;color:rgba(255,255,255,.7);transition:var(--trans);border:none;background:none}
    .topbar .mode-tab.active{background:var(--acc);color:var(--pri-d)}
    html.dark .topbar .mode-tab.active{color:#000}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .section{display:none}
    .section.active{display:block}
    .page-title{font-size:1.6rem;margin-bottom:6px}
    .page-sub{color:var(--txt3);margin-bottom:20px;font-size:.92rem}
    .card{background:var(--card);border-radius:var(--rad2);padding:20px;box-shadow:var(--shd);border:1px solid var(--brd);margin-bottom:16px;transition:var(--trans)}
    .card:hover{box-shadow:var(--shd2)}
    .card-h{font-size:1.1rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .card-h i{color:var(--acc);font-size:1rem}
    .nav-pills{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--brd)}
    .pill{padding:7px 14px;border-radius:20px;cursor:pointer;font-size:.8rem;font-weight:600;color:var(--txt2);background:var(--bg2);border:1px solid var(--brd);transition:var(--trans)}
    .pill.active{background:var(--pri);color:#fff;border-color:var(--pri)}
    html.dark .pill.active{color:#000}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;font-weight:600;font-size:.85rem;margin-bottom:5px;color:var(--txt2)}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid var(--brd);border-radius:var(--rad);background:var(--card);color:var(--txt);font-size:16px;font-family:inherit;transition:var(--trans)}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(27,67,50,.12)}
    html.dark .form-group input:focus,html.dark .form-group select:focus,html.dark .form-group textarea:focus{box-shadow:0 0 0 3px rgba(74,222,128,.15)}
    .form-group textarea{resize:vertical;min-height:80px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:600px){.form-row{grid-template-columns:1fr}}
    .btn{padding:10px 20px;border:none;border-radius:var(--rad);font-family:inherit;font-weight:600;font-size:.9rem;cursor:pointer;transition:var(--trans);display:inline-flex;align-items:center;gap:6px}
    .btn-pri{background:var(--pri);color:#fff}
    .btn-pri:hover{background:var(--pri-l)}
    html.dark .btn-pri{color:#000}
    .btn-acc{background:var(--acc);color:var(--pri-d)}
    .btn-acc:hover{background:var(--acc-l)}
    .btn-err{background:var(--err);color:#fff}
    .btn-err:hover{opacity:.85}
    .btn-out{background:transparent;border:1.5px solid var(--brd);color:var(--txt2)}
    .btn-out:hover{border-color:var(--pri);color:var(--pri)}
    .btn-wa{background:#25D366;color:#fff}
    .btn-wa:hover{background:#1DA851}
    .btn-sm{padding:6px 12px;font-size:.78rem}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.72rem;font-weight:700}
    .badge-suc{background:var(--suc-l);color:var(--suc)}
    .badge-err{background:var(--err-l);color:var(--err)}
    .badge-warn{background:var(--warn-l);color:var(--warn)}
    .badge-pri{background:rgba(27,67,50,.1);color:var(--pri)}
    html.dark .badge-pri{background:rgba(74,222,128,.15)}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
    .stat-card{background:var(--card);border-radius:var(--rad);padding:16px;text-align:center;border:1px solid var(--brd);box-shadow:var(--shd)}
    .stat-card .num{font-family:'Bricolage Grotesque',sans-serif;font-size:1.8rem;font-weight:800;color:var(--pri)}
    .stat-card .lbl{font-size:.78rem;color:var(--txt3);margin-top:2px}
    .tbl-wrap{overflow-x:auto;border-radius:var(--rad);border:1px solid var(--brd)}
    .tbl{width:100%;border-collapse:collapse;font-size:.82rem}
    .tbl th{background:var(--bg2);font-weight:700;text-align:left;padding:10px 12px;color:var(--txt2);white-space:nowrap;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px}
    .tbl td{padding:9px 12px;border-top:1px solid var(--brd);vertical-align:middle}
    .tbl tr:hover td{background:var(--card2)}
    .search-bar{position:relative;margin-bottom:14px}
    .search-bar input{padding-left:36px}
    .search-bar i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--txt3)}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:16px}
    .modal-overlay.show{display:flex}
    .modal{background:var(--card);border-radius:var(--rad2);padding:24px;max-width:540px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:var(--shd2);animation:modalIn .25s ease}
    @keyframes modalIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .modal-h{font-size:1.15rem;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
    .modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--txt3);padding:4px}
    .toast-container{position:fixed;top:70px;right:16px;z-index:300;display:flex;flex-direction:column;gap:8px}
    .toast{padding:12px 18px;border-radius:var(--rad);color:#fff;font-size:.85rem;font-weight:600;animation:toastIn .3s ease;box-shadow:var(--shd2);max-width:320px}
    .toast-suc{background:var(--suc)}
    .toast-err{background:var(--err)}
    .toast-warn{background:var(--warn)}
    @keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
    .rules-box{max-height:300px;overflow-y:auto;background:var(--card2);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:14px;font-size:.85rem;line-height:1.7}
    .rules-box h4{margin:12px 0 6px;color:var(--pri)}
    .rules-box ol,.rules-box ul{padding-left:20px}
    .check-row{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .check-row input[type=checkbox]{width:20px;height:20px;accent-color:var(--pri)}
    .empty-state{text-align:center;padding:40px 20px;color:var(--txt3)}
    .empty-state i{font-size:2.5rem;margin-bottom:10px;opacity:.4}
    .empty-state p{font-size:.9rem}
    .admin-login-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
    .admin-login-card{max-width:400px;width:100%;text-align:center}
    .admin-login-card .lock-icon{width:70px;height:70px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:1.6rem;color:var(--pri)}
    .pass-input{font-size:1rem;letter-spacing:2px;font-weight:600}
    .lockout-bar{background:var(--err-l);color:var(--err);padding:10px 14px;border-radius:var(--rad);font-size:.82rem;font-weight:600;margin-bottom:12px;display:none}
    .room-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .room-cell{padding:16px 10px;border-radius:var(--rad);text-align:center;font-weight:700;font-size:.82rem;border:1.5px solid var(--brd);cursor:default;transition:var(--trans);position:relative}
    .room-cell.full{background:var(--err-l);border-color:var(--err);color:var(--err)}
    .room-cell.partial{background:var(--warn-l);border-color:var(--warn);color:var(--warn)}
    .room-cell.empty{background:var(--suc-l);border-color:var(--suc);color:var(--suc)}
    .room-cell .room-name{font-size:.95rem;margin-bottom:2px}
    .room-cell .room-occ{font-size:.7rem;opacity:.8}
    .notice-card{border-left:4px solid var(--acc)}
    .notice-card .notice-date{font-size:.75rem;color:var(--txt3)}
    .notice-card .notice-title{font-weight:700;margin:4px 0}
    .tab-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .honeypot{position:absolute;left:-9999px;opacity:0;height:0}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn .35s ease}
    .settings-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--brd)}
    .settings-row:last-child{border:none}
    .settings-row label{flex:1;font-weight:600;font-size:.88rem}
    .settings-row input{flex:2}
    .export-section{margin-bottom:24px}
    .export-section h4{margin-bottom:10px;font-size:.95rem}
    .export-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px}
    .gs-status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:.75rem;font-weight:700}
    .gs-on{background:var(--suc-l);color:var(--suc)}
    .gs-off{background:var(--err-l);color:var(--err)}
    .strength-bar{height:4px;border-radius:2px;background:var(--bg3);margin-top:4px;overflow:hidden}
    .strength-fill{height:100%;border-radius:2px;transition:width .3s ease,background .3s ease}
    /* Remove gas-guide styles if you want, but keep for now */
  </style>
</head>
<body>
  <!-- (All HTML structure remains EXACTLY the same as before) -->
  <!-- Topbar, resident portal, admin portal, modals... unchanged -->
  <!-- I'm omitting the full HTML here for brevity ‚Äì you must keep your original HTML exactly as is. -->
  <!-- Only the JavaScript part changes. -->

  <!-- Paste your original HTML here (lines 1‚Äì719) exactly as they were. -->
  <!-- Then replace the <script> section (from line 720 onward) with the new script below. -->

  <script>
    // ===== SUPABASE INIT =====
    const SUPABASE_URL = 'https://your-project-url.supabase.co';  // <-- REPLACE
    const SUPABASE_ANON_KEY = 'your-anon-key';                    // <-- REPLACE
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== ROOM DEFINITIONS (unchanged) =====
    const ROOMS = [
      { id: 'blue-white', name: 'Blue-White', capacity: 3 },
      { id: 'black-gold', name: 'Black-Gold', capacity: 3 },
      { id: 'ensuite', name: 'Ensuite', capacity: 3 },
      { id: 'crystal-1', name: 'Crystal 1', capacity: 2 },
      { id: 'crystal-2', name: 'Crystal 2', capacity: 2 }
    ];
    const TOTAL_CAPACITY = 13;
    const ADMIN_PHONE = '263771308790';

    // ===== LOCAL CACHE (mirrors Supabase tables) =====
    let DB = {
      residents: [],
      checkins: [],
      checkouts: [],
      rulesAcceptance: [],
      payments: [],
      incidents: [],
      maintenance: [],
      power: [],
      water: [],
      notices: [],
      activity: []          // activity will be stored locally only (optional)
    };

    // ===== HELPER FUNCTIONS (unchanged) =====
    function now() { return new Date().toISOString(); }
    function fmtDate(iso) { if(!iso) return '-'; var d = new Date(iso); return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
    function fmtDateTime(iso) { if(!iso) return '-'; var d = new Date(iso); return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
    function addActivity(msg) { DB.activity.unshift({msg:msg,time:now()}); if(DB.activity.length>50) DB.activity.pop(); }
    function esc(str){ var d=document.createElement('div'); d.textContent=str||''; return d.innerHTML; }
    function getRoomName(id) { var r = ROOMS.find(x=>x.id===id); return r ? r.name : id; }
    function getRoomOccupants(roomId) { return DB.residents.filter(r=>r.room===roomId); }
    function isRoomFull(roomId) { var rm = ROOMS.find(x=>x.id===roomId); if(!rm) return true; return getRoomOccupants(roomId).length >= rm.capacity; }

    // ===== TOAST (unchanged) =====
    function toast(msg,type) {
      var t = document.createElement('div');
      t.className = 'toast toast-'+(type||'suc');
      t.textContent = msg;
      document.getElementById('toasts').appendChild(t);
      setTimeout(function(){ t.remove(); },3500);
    }

    // ===== MODAL (unchanged) =====
    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    function showConfirm(title,msg,onConfirm) {
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMsg').textContent = msg;
      var btn = document.getElementById('confirmBtn');
      var newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      newBtn.id = 'confirmBtn';
      newBtn.addEventListener('click', function(){ closeModal('confirmModal'); onConfirm(); });
      openModal('confirmModal');
    }

    // ===== LOAD ALL DATA FROM SUPABASE =====
    async function loadAllData() {
      try {
        const [
          { data: residents },
          { data: checkins },
          { data: checkouts },
          { data: rules },
          { data: payments },
          { data: incidents },
          { data: maintenance },
          { data: power },
          { data: water },
          { data: notices }
        ] = await Promise.all([
          supabase.from('residents').select('*'),
          supabase.from('checkins').select('*'),
          supabase.from('checkouts').select('*'),
          supabase.from('rulesAcceptance').select('*'),
          supabase.from('payments').select('*'),
          supabase.from('incidents').select('*'),
          supabase.from('maintenance').select('*'),
          supabase.from('power').select('*'),
          supabase.from('water').select('*'),
          supabase.from('notices').select('*')
        ]);

        DB.residents = residents || [];
        DB.checkins = checkins || [];
        DB.checkouts = checkouts || [];
        DB.rulesAcceptance = rules || [];
        DB.payments = payments || [];
        DB.incidents = incidents || [];
        DB.maintenance = maintenance || [];
        DB.power = power || [];
        DB.water = water || [];
        DB.notices = notices || [];

        // Activity log ‚Äì we don't persist it; just keep local.
        DB.activity = [];

        // Refresh UI if admin is logged in
        if (document.getElementById('adminDash').style.display !== 'none') {
          const activeTab = document.querySelector('#adminNavPills .pill.active')?.dataset.tab;
          if (activeTab) refreshAdminTab(activeTab);
        }
        renderResNotices(); // always refresh resident notices
        toast('Data loaded from Supabase');
      } catch (err) {
        console.error(err);
        toast('Failed to load data: ' + err.message, 'err');
      }
    }

    // Call loadAllData on page load (but after admin login we'll call it again)
    loadAllData();

    // ===== NAVIGATION (unchanged) =====
    function switchMode(mode) {
      document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      if(mode==='resident') {
        document.querySelector('.mode-tab:nth-child(1)').classList.add('active');
        document.getElementById('residentPortal').classList.add('active');
      } else {
        document.querySelector('.mode-tab:nth-child(2)').classList.add('active');
        document.getElementById('adminPortal').classList.add('active');
        // When switching to admin, ensure data is loaded (if not already)
        if (document.getElementById('adminDash').style.display !== 'none') {
          const activeTab = document.querySelector('#adminNavPills .pill.active')?.dataset.tab;
          if (activeTab) refreshAdminTab(activeTab);
        }
      }
    }

    function setupTabs(navId, tabClass) {
      document.getElementById(navId).addEventListener('click', function(e){
        var pill = e.target.closest('.pill');
        if(!pill) return;
        document.querySelectorAll('#'+navId+' .pill').forEach(p=>p.classList.remove('active'));
        pill.classList.add('active');
        document.querySelectorAll('.'+tabClass).forEach(t=>t.style.display='none');
        var target = document.getElementById(pill.dataset.tab);
        if(target){target.style.display='block';target.classList.remove('active');void target.offsetWidth;target.classList.add('active');}
        if(tabClass==='adm-tab') refreshAdminTab(pill.dataset.tab);
      });
    }
    setupTabs('resNavPills','res-tab');

    // ===== ROOM SELECT POPULATION (unchanged) =====
    function getRoomOptions() {
      var html = '<option value="">Select Room</option>';
      ROOMS.forEach(r=> html += '<option value="'+r.id+'">'+r.name+' ('+r.capacity+' beds)</option>');
      return html;
    }
    function populateRoomSelects() {
      var html = getRoomOptions();
      ['ci_room','ra_room','mt_room','in_room','co_room','ar_room'].forEach(id=>{
        var el = document.getElementById(id);
        if(el) el.innerHTML = html;
      });
    }
    populateRoomSelects();

    // ===== RESIDENT FORMS (now async with Supabase) =====
    async function handleCheckin(e) {
      e.preventDefault();
      var hp = e.target.querySelector('.honeypot');
      if(hp && hp.value) return false;
      var roomId = document.getElementById('ci_room').value;
      if(isRoomFull(roomId)) { toast(getRoomName(roomId)+' is already at full capacity!','err'); return false; }

      var data = {
        name: document.getElementById('ci_name').value.trim(),
        phone: document.getElementById('ci_phone').value.trim(),
        institution: document.getElementById('ci_institution').value.trim(),
        idNumber: document.getElementById('ci_id').value.trim(),
        room: roomId,
        date: document.getElementById('ci_date').value,
        status: document.getElementById('ci_status').value,
        deposit: document.getElementById('ci_deposit').value,
        notes: document.getElementById('ci_notes').value.trim(),
        createdAt: now()
      };

      // Insert into checkins table
      const { data: newCheckin, error: ciError } = await supabase.from('checkins').insert(data).select().single();
      if (ciError) { toast('Error saving check-in: '+ciError.message, 'err'); return false; }
      DB.checkins.push(newCheckin);

      // Handle resident
      var existing = DB.residents.find(r=>r.idNumber===data.idNumber);
      if (!existing) {
        const residentData = {
          name: data.name,
          phone: data.phone,
          institution: data.institution,
          idNumber: data.idNumber,
          room: data.room,
          status: data.status,
          checkinDate: data.date,
          paymentStatus: data.deposit,
          notes: data.notes,
          createdAt: now()
        };
        const { data: newResident, error: resError } = await supabase.from('residents').insert(residentData).select().single();
        if (resError) { toast('Error saving resident: '+resError.message, 'err'); return false; }
        DB.residents.push(newResident);
      } else {
        // Update existing resident
        const updates = {
          room: data.room,
          phone: data.phone,
          checkinDate: data.date,
          paymentStatus: data.deposit
        };
        const { error: updError } = await supabase.from('residents').update(updates).eq('id', existing.id);
        if (updError) { toast('Error updating resident: '+updError.message, 'err'); return false; }
        Object.assign(existing, updates);
      }

      addActivity('Check-in: '+data.name+' ‚Üí '+getRoomName(data.room));
      toast('Check-in submitted successfully!');
      e.target.reset();
      document.getElementById('ci_date').value = new Date().toISOString().split('T')[0];
      return false;
    }

    async function handleRulesAccept(e) {
      e.preventDefault();
      var data = {
        name: document.getElementById('ra_name').value.trim(),
        room: document.getElementById('ra_room').value,
        accepted: true,
        acceptedAt: now(),
        version: 'Rules v1.0'
      };
      const { data: newRule, error } = await supabase.from('rulesAcceptance').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.rulesAcceptance.push(newRule);
      addActivity('Rules accepted by '+data.name);
      toast('Rules acceptance recorded. Thank you!');
      e.target.reset();
      return false;
    }

    async function handleMaintenance(e) {
      e.preventDefault();
      var data = {
        name: document.getElementById('mt_name').value.trim(),
        room: document.getElementById('mt_room').value,
        category: document.getElementById('mt_category').value,
        urgency: document.getElementById('mt_urgency').value,
        description: document.getElementById('mt_desc').value.trim(),
        status: 'Open',
        createdAt: now()
      };
      const { data: newMaint, error } = await supabase.from('maintenance').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.maintenance.push(newMaint);
      addActivity('Maintenance request from '+data.name+': '+data.category);
      toast('Maintenance request submitted!');
      e.target.reset();
      return false;
    }

    async function handleIncident(e) {
      e.preventDefault();
      var data = {
        submittedBy: document.getElementById('in_name').value.trim(),
        room: document.getElementById('in_room').value,
        type: document.getElementById('in_type').value,
        urgency: document.getElementById('in_urgency').value,
        description: document.getElementById('in_desc').value.trim(),
        status: 'Open',
        adminNotes: '',
        createdAt: now(),
        closedAt: null
      };
      const { data: newInc, error } = await supabase.from('incidents').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.incidents.push(newInc);
      addActivity('Incident reported by '+data.submittedBy+': '+data.type);
      toast('Incident report submitted! Opening WhatsApp...');
      sendWhatsAppIncident(data); // uses local data
      e.target.reset();
      return false;
    }

    async function handleCheckout(e) {
      e.preventDefault();
      var data = {
        name: document.getElementById('co_name').value.trim(),
        room: document.getElementById('co_room').value,
        date: document.getElementById('co_date').value,
        keyReturned: document.getElementById('co_key').value,
        condition: document.getElementById('co_condition').value.trim(),
        forwardContact: document.getElementById('co_forward').value.trim(),
        createdAt: now()
      };
      const { data: newCheckout, error } = await supabase.from('checkouts').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.checkouts.push(newCheckout);

      // Remove resident from room
      var res = DB.residents.find(r => r.room === data.room && r.name.toLowerCase() === data.name.toLowerCase());
      if (res) {
        const { error: updError } = await supabase.from('residents').update({ room: '' }).eq('id', res.id);
        if (!updError) res.room = '';
      }

      addActivity('Check-out: '+data.name+' from '+getRoomName(data.room));
      toast('Check-out submitted successfully!');
      e.target.reset();
      return false;
    }

    // WhatsApp (unchanged)
    function sendWhatsAppIncident(data) {
      var msg = 'üö® *INCIDENT REPORT*\n\n';
      msg += 'üë§ *Reported by:* '+data.submittedBy+'\n';
      msg += 'üè† *Room:* '+getRoomName(data.room)+'\n';
      msg += '‚ö†Ô∏è *Type:* '+data.type+'\n';
      msg += 'üî¥ *Urgency:* '+data.urgency+'\n';
      msg += 'üìù *Description:*\n'+data.description+'\n\n';
      msg += 'üìÖ '+fmtDateTime(data.createdAt);
      var encoded = encodeURIComponent(msg);
      var url = 'https://wa.me/'+ADMIN_PHONE+'?text='+encoded;
      window.open(url,'_blank');
    }

    // ===== ADMIN SECURITY (with Supabase config) =====
    let loginAttempts = 0, lockoutUntil = 0, MAX_ATTEMPTS = 5, LOCKOUT_SECONDS = 60, lockoutTimer = null;

    async function handleAdminLogin(e) {
      e.preventDefault();
      var nowMs = Date.now();
      if(nowMs < lockoutUntil) {
        var secs = Math.ceil((lockoutUntil-nowMs)/1000);
        showLockout(secs);
        return false;
      }
      var val = document.getElementById('adminPin').value;

      // Fetch the stored PIN hash from config table
      const { data, error } = await supabase.from('config').select('pin_hash').eq('id', 1).single();
      if (error || !data) {
        toast('Config error: '+ (error?.message || 'PIN not set'), 'err');
        return false;
      }
      const storedHash = data.pin_hash;

      // Hash the entered password (simple SHA‚Äë256 via browser crypto)
      const encoder = new TextEncoder();
      const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(val));
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      if (hashHex === storedHash) {
        loginAttempts = 0;
        hideLockout();
        document.getElementById('adminLogin').style.display='none';
        document.getElementById('adminDash').style.display='block';
        setupTabs('adminNavPills','adm-tab');
        await loadAllData(); // refresh data
        refreshAdminTab('adm-overview');
        toast('Welcome, Admin!');
        addActivity('Admin logged in');
      } else {
        loginAttempts++;
        var remaining = MAX_ATTEMPTS - loginAttempts;
        if(remaining <= 0) {
          lockoutUntil = nowMs + (LOCKOUT_SECONDS*1000);
          loginAttempts = 0;
          showLockout(LOCKOUT_SECONDS);
          startLockoutCountdown();
          toast('Too many failed attempts. Locked out for '+LOCKOUT_SECONDS+'s','err');
        } else {
          toast('Incorrect password. '+remaining+' attempt'+(remaining===1?'':'s')+' remaining.','err');
        }
      }
      document.getElementById('adminPin').value='';
      updateStrength('');
      return false;
    }

    function showLockout(secs) {
      var bar = document.getElementById('lockoutBar');
      bar.style.display='block';
      document.getElementById('lockoutMsg').textContent = 'Account locked. Try again in '+secs+' seconds.';
      document.getElementById('loginBtn').disabled = true;
    }
    function hideLockout() {
      document.getElementById('lockoutBar').style.display='none';
      document.getElementById('loginBtn').disabled = false;
      if(lockoutTimer) { clearInterval(lockoutTimer); lockoutTimer=null; }
    }
    function startLockoutCountdown() {
      if(lockoutTimer) clearInterval(lockoutTimer);
      lockoutTimer = setInterval(function(){
        var remaining = Math.ceil((lockoutUntil-Date.now())/1000);
        if(remaining<=0) { hideLockout(); }
        else { document.getElementById('lockoutMsg').textContent='Account locked. Try again in '+remaining+' seconds.'; }
      },1000);
    }

    function adminLogout() {
      document.getElementById('adminLogin').style.display='';
      document.getElementById('adminDash').style.display='none';
      toast('Logged out');
      addActivity('Admin logged out');
    }

    // Password strength indicator (unchanged)
    document.getElementById('adminPin').addEventListener('input',function(){
      updateStrength(this.value);
    });
    function updateStrength(val) {
      var fill = document.getElementById('strengthFill');
      if(!val) { fill.style.width='0%'; return; }
      var score = 0;
      if(val.length>=4) score++;
      if(val.length>=8) score++;
      if(/[A-Z]/.test(val)) score++;
      if(/[0-9]/.test(val)) score++;
      if(/[^A-Za-z0-9]/.test(val)) score++;
      var pct = Math.min(100, score*20);
      fill.style.width = pct+'%';
      fill.style.background = pct<=40?'var(--err)':pct<=60?'var(--warn)':'var(--suc)';
    }

    // ===== ADMIN TABS (render functions use DB cache) =====
    function refreshAdminTab(tab) {
      if(tab==='adm-overview') renderOverview();
      else if(tab==='adm-residents') renderResidents();
      else if(tab==='adm-rooms') renderRooms();
      else if(tab==='adm-payments') renderPayments();
      else if(tab==='adm-utilities'){renderPower();renderWater();}
      else if(tab==='adm-incidents') renderIncidents();
      else if(tab==='adm-notices') renderAdminNotices();
    }

    function renderOverview() {
      var totalOcc = DB.residents.filter(r=>r.room).length;
      var stats = [
        {n:DB.residents.length, l:'Total Residents', i:'fa-users'},
        {n:totalOcc+'/'+TOTAL_CAPACITY, l:'Beds Occupied', i:'fa-bed'},
        {n:DB.incidents.filter(i=>i.status==='Open').length, l:'Open Incidents', i:'fa-flag'},
        {n:DB.maintenance.filter(m=>m.status==='Open').length, l:'Pending Maintenance', i:'fa-wrench'},
        {n:DB.payments.length, l:'Payments Recorded', i:'fa-money-bill'},
        {n:DB.checkins.length, l:'Total Check-Ins', i:'fa-right-to-bracket'}
      ];
      document.getElementById('statsGrid').innerHTML = stats.map(s=>
        '<div class="stat-card"><div class="num">'+s.n+'</div><div class="lbl"><i class="fas '+s.i+'"></i> '+s.l+'</div></div>'
      ).join('');

      var log = DB.activity.slice(0,15);
      document.getElementById('activityLog').innerHTML = log.length
        ? log.map(a=>'<div style="padding:8px 0;border-bottom:1px solid var(--brd);font-size:.84rem"><span style="color:var(--txt3);font-size:.75rem;margin-right:8px">'+fmtDateTime(a.time)+'</span>'+esc(a.msg)+'</div>').join('')
        : '<div class="empty-state"><i class="fas fa-clock"></i><p>No activity yet</p></div>';
    }

    function renderResidents() {
      var q = (document.getElementById('residentSearch').value||'').toLowerCase();
      var filtered = DB.residents.filter(r=>!q||r.name.toLowerCase().includes(q)||getRoomName(r.room).toLowerCase().includes(q)||r.status.toLowerCase().includes(q));
      document.getElementById('residentsBody').innerHTML = filtered.length
        ? filtered.map(r=>'<tr><td><strong>'+esc(r.name)+'</strong></td><td>'+(r.room?getRoomName(r.room):'-')+'</td><td>'+esc(r.phone)+'</td><td><span class="badge badge-'+(r.status==='New'?'pri':'suc')+'">'+r.status+'</span></td><td><span class="badge badge-'+(r.paymentStatus==='Paid'?'suc':r.paymentStatus==='Pending'?'err':'warn')+'">'+(r.paymentStatus||'-')+'</span></td><td><button class="btn btn-out btn-sm" onclick="removeResident(\''+r.id+'\')"><i class="fas fa-trash"></i></button></td></tr>').join('')
        : '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-users"></i><p>No residents found</p></div></td></tr>';
    }

    async function removeResident(id) {
      showConfirm('Remove Resident','Are you sure you want to remove this resident?', async ()=>{
        const { error } = await supabase.from('residents').delete().eq('id', id);
        if (error) { toast('Error: '+error.message, 'err'); return; }
        DB.residents = DB.residents.filter(r=>r.id!==id);
        addActivity('Resident removed');
        renderResidents();
        toast('Resident removed');
      });
    }

    async function addResidentManual(e) {
      e.preventDefault();
      var roomId = document.getElementById('ar_room').value;
      if(isRoomFull(roomId)){ toast(getRoomName(roomId)+' is at full capacity!','err'); return false; }
      var data = {
        name: document.getElementById('ar_name').value.trim(),
        phone: document.getElementById('ar_phone').value.trim(),
        institution: document.getElementById('ar_inst').value.trim(),
        idNumber: document.getElementById('ar_id').value.trim(),
        room: roomId,
        status: document.getElementById('ar_status').value,
        checkinDate: new Date().toISOString().split('T')[0],
        paymentStatus: 'Pending',
        notes: '',
        createdAt: now()
      };
      const { data: newRes, error } = await supabase.from('residents').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.residents.push(newRes);
      addActivity('Resident added: '+data.name+' ‚Üí '+getRoomName(roomId));
      closeModal('addResidentModal');
      renderResidents();
      toast('Resident added!');
      e.target.reset();
      return false;
    }

    function renderRooms() {
      var html = '';
      ROOMS.forEach(rm=>{
        var occ = getRoomOccupants(rm.id);
        var cls = occ.length===0?'empty':occ.length>=rm.capacity?'full':'partial';
        html += '<div class="room-cell '+cls+'" onclick="showRoomDetail(\''+rm.id+'\')">';
        html += '<div class="room-name">'+esc(rm.name)+'</div>';
        html += '<div class="room-occ">'+occ.length+' / '+rm.capacity+' beds</div>';
        html += '</div>';
      });
      document.getElementById('roomGrid').innerHTML = html;
    }

    function showRoomDetail(roomId) {
      var rm = ROOMS.find(x=>x.id===roomId);
      if(!rm) return;
      var occ = getRoomOccupants(roomId);
      document.getElementById('roomDetailTitle').textContent = rm.name+' ‚Äî '+occ.length+'/'+rm.capacity+' beds';
      var body = '';
      if(occ.length===0) {
        body = '<p style="color:var(--txt3)">No residents currently assigned to this room.</p>';
      } else {
        body = '<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Name</th><th>Phone</th><th>Status</th></tr></thead><tbody>';
        occ.forEach(r=>{
          body += '<tr><td>'+esc(r.name)+'</td><td>'+esc(r.phone)+'</td><td><span class="badge badge-'+(r.paymentStatus==='Paid'?'suc':'warn')+'">'+r.paymentStatus+'</span></td></tr>';
        });
        body += '</tbody></table></div>';
      }
      document.getElementById('roomDetailBody').innerHTML = body;
      document.getElementById('roomDetailCard').style.display = 'block';
    }

    function renderPayments() {
      var q = (document.getElementById('paymentSearch').value||'').toLowerCase();
      var filtered = DB.payments.filter(p=>!q||p.name.toLowerCase().includes(q)||p.method.toLowerCase().includes(q));
      document.getElementById('paymentsBody').innerHTML = filtered.length
        ? filtered.map(p=>'<tr><td>'+fmtDate(p.paidDate)+'</td><td>'+esc(p.name)+'</td><td>'+esc(p.month)+'</td><td><strong>$'+Number(p.amount).toFixed(2)+'</strong></td><td>$'+Number(p.balance).toFixed(2)+'</td><td>'+esc(p.method)+'</td><td>'+esc(p.ref||'-')+'</td></tr>').join('')
        : '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-money-bill"></i><p>No payments recorded</p></div></td></tr>';
    }

    async function addPayment(e) {
      e.preventDefault();
      var data = {
        name: document.getElementById('pm_name').value.trim(),
        month: document.getElementById('pm_month').value,
        amount: document.getElementById('pm_amount').value,
        balance: document.getElementById('pm_balance').value||0,
        method: document.getElementById('pm_method').value,
        ref: document.getElementById('pm_ref').value.trim(),
        notes: document.getElementById('pm_notes').value.trim(),
        paidDate: now(),
        recordedBy: 'Admin'
      };
      const { data: newPay, error } = await supabase.from('payments').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.payments.push(newPay);
      addActivity('Payment: $'+data.amount+' from '+data.name);
      closeModal('addPaymentModal');
      renderPayments();
      toast('Payment recorded!');
      e.target.reset();
      return false;
    }

    function renderPower() {
      document.getElementById('powerBody').innerHTML = DB.power.length
        ? DB.power.map(p=>'<tr><td>'+fmtDate(p.date)+'</td><td>'+p.units+'</td><td>$'+Number(p.amount).toFixed(2)+'</td><td>'+(p.balance||'-')+'</td><td>'+esc(p.notes||'-')+'</td></tr>').join('')
        : '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-bolt"></i><p>No electricity records</p></div></td></tr>';
    }
    function renderWater() {
      document.getElementById('waterBody').innerHTML = DB.water.length
        ? DB.water.map(w=>'<tr><td>'+fmtDate(w.date)+'</td><td>'+w.litres+'L</td><td>'+esc(w.supplier||'-')+'</td><td>$'+Number(w.cost).toFixed(2)+'</td><td>'+w.filled+'</td><td>'+esc(w.notes||'-')+'</td></tr>').join('')
        : '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-droplet"></i><p>No water records</p></div></td></tr>';
    }

    async function addPower(e) {
      e.preventDefault();
      var data = {
        date: document.getElementById('pw_date').value,
        units: document.getElementById('pw_units').value,
        amount: document.getElementById('pw_amount').value,
        balance: document.getElementById('pw_balance').value,
        notes: document.getElementById('pw_notes').value.trim()
      };
      const { data: newPower, error } = await supabase.from('power').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.power.push(newPower);
      addActivity('Electricity recharge: '+data.units+' units');
      closeModal('addPowerModal');
      renderPower();
      toast('Electricity record saved!');
      e.target.reset();
      return false;
    }
    async function addWater(e) {
      e.preventDefault();
      var data = {
        date: document.getElementById('wt_date').value,
        litres: document.getElementById('wt_litres').value,
        supplier: document.getElementById('wt_supplier').value.trim(),
        cost: document.getElementById('wt_cost').value,
        filled: document.getElementById('wt_filled').value,
        notes: document.getElementById('wt_notes').value.trim()
      };
      const { data: newWater, error } = await supabase.from('water').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.water.push(newWater);
      addActivity('Water delivery: '+data.litres+'L');
      closeModal('addWaterModal');
      renderWater();
      toast('Water record saved!');
      e.target.reset();
      return false;
    }

    function switchUtilTab(tab) {
      document.querySelectorAll('.util-tab').forEach(t=>t.classList.remove('active'));
      document.querySelector('.util-tab[data-util="'+tab+'"]').classList.add('active');
      document.getElementById('util-power').style.display = tab==='power'?'block':'none';
      document.getElementById('util-water').style.display = tab==='water'?'block':'none';
    }

    function renderIncidents() {
      var q = (document.getElementById('incidentSearch').value||'').toLowerCase();
      var filtered = DB.incidents.filter(i=>!q||i.submittedBy.toLowerCase().includes(q)||i.type.toLowerCase().includes(q)||i.status.toLowerCase().includes(q));
      document.getElementById('incidentsBody').innerHTML = filtered.length
        ? filtered.map(i=>'<tr><td>'+fmtDate(i.createdAt)+'</td><td>'+esc(i.submittedBy)+'</td><td>'+getRoomName(i.room)+'</td><td>'+i.type+'</td><td><span class="badge badge-'+urgBadge(i.urgency)+'">'+i.urgency+'</span></td><td><span class="badge badge-'+statusBadge(i.status)+'">'+i.status+'</span></td><td><button class="btn btn-out btn-sm" onclick="viewIncident(\''+i.id+'\')"><i class="fas fa-eye"></i></button> <button class="btn btn-sm btn-'+(i.status==='Closed'?'out':'pri')+'" onclick="toggleIncident(\''+i.id+'\')">'+(i.status==='Closed'?'Reopen':'Close')+'</button></td></tr>').join('')
        : '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-flag"></i><p>No incidents</p></div></td></tr>';
    }
    function urgBadge(u){return u==='Critical'||u==='High'?'err':u==='Medium'?'warn':'suc';}
    function statusBadge(s){return s==='Open'?'err':s==='In Progress'?'warn':'suc';}

    function viewIncident(id) {
      var i = DB.incidents.find(x=>x.id===id);
      if(!i) return;
      document.getElementById('incidentDetail').innerHTML = '<div style="font-size:.88rem;line-height:1.8"><p><strong>Reported by:</strong> '+esc(i.submittedBy)+'</p><p><strong>Room:</strong> '+getRoomName(i.room)+'</p><p><strong>Type:</strong> '+i.type+'</p><p><strong>Urgency:</strong> <span class="badge badge-'+urgBadge(i.urgency)+'">'+i.urgency+'</span></p><p><strong>Status:</strong> <span class="badge badge-'+statusBadge(i.status)+'">'+i.status+'</span></p><p><strong>Date:</strong> '+fmtDateTime(i.createdAt)+'</p><p><strong>Description:</strong></p><p style="background:var(--bg2);padding:10px;border-radius:8px">'+esc(i.description)+'</p></div>';
      openModal('viewIncidentModal');
    }
    async function toggleIncident(id) {
      var i = DB.incidents.find(x=>x.id===id);
      if(!i) return;
      var newStatus = i.status === 'Closed' ? 'Open' : 'Closed';
      var updates = { status: newStatus };
      if (newStatus === 'Closed') updates.closedAt = now();
      else updates.closedAt = null;
      const { error } = await supabase.from('incidents').update(updates).eq('id', id);
      if (error) { toast('Error: '+error.message, 'err'); return; }
      i.status = newStatus;
      i.closedAt = updates.closedAt;
      addActivity('Incident '+i.id+' '+newStatus.toLowerCase());
      renderIncidents();
      toast('Incident '+newStatus.toLowerCase());
    }

    function renderAdminNotices() {
      document.getElementById('adminNoticesList').innerHTML = DB.notices.length
        ? DB.notices.map(n=>'<div class="card notice-card"><div class="notice-date">'+fmtDateTime(n.createdAt)+' <span class="badge badge-'+(n.priority==='Urgent'?'err':n.priority==='Important'?'warn':'pri')+'">'+n.priority+'</span></div><div class="notice-title">'+esc(n.title)+'</div><p style="font-size:.85rem;color:var(--txt2);margin-top:4px">'+esc(n.content)+'</p><button class="btn btn-out btn-sm" style="margin-top:8px" onclick="removeNotice(\''+n.id+'\')"><i class="fas fa-trash"></i> Remove</button></div>').join('')
        : '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No notices posted</p></div>';
    }

    async function addNotice(e) {
      e.preventDefault();
      var data = {
        title: document.getElementById('nt_title').value.trim(),
        content: document.getElementById('nt_content').value.trim(),
        priority: document.getElementById('nt_priority').value,
        createdAt: now()
      };
      const { data: newNotice, error } = await supabase.from('notices').insert(data).select().single();
      if (error) { toast('Error: '+error.message, 'err'); return false; }
      DB.notices.unshift(newNotice);
      addActivity('Notice posted: '+data.title);
      closeModal('addNoticeModal');
      renderAdminNotices();
      renderResNotices();
      toast('Notice published!');
      e.target.reset();
      return false;
    }
    async function removeNotice(id) {
      showConfirm('Remove Notice','Are you sure you want to remove this notice?', async ()=>{
        const { error } = await supabase.from('notices').delete().eq('id', id);
        if (error) { toast('Error: '+error.message, 'err'); return; }
        DB.notices = DB.notices.filter(n=>n.id!==id);
        renderAdminNotices();
        renderResNotices();
        toast('Notice removed');
      });
    }

    function renderResNotices() {
      document.getElementById('resNoticesList').innerHTML = DB.notices.length
        ? DB.notices.map(n=>'<div class="card notice-card fade-in"><div class="notice-date">'+fmtDateTime(n.createdAt)+' <span class="badge badge-'+(n.priority==='Urgent'?'err':n.priority==='Important'?'warn':'pri')+'">'+n.priority+'</span></div><div class="notice-title">'+esc(n.title)+'</div><p style="font-size:.85rem;color:var(--txt2);margin-top:4px">'+esc(n.content)+'</p></div>').join('')
        : '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No notices at this time</p></div>';
    }

    // ===== SETTINGS (PIN update) =====
    async function updatePin() {
      var v = document.getElementById('settingPin').value;
      if(v.length<6){ toast('Password must be at least 6 characters','err'); return; }
      if(v.length>12){ toast('Password cannot exceed 12 characters','err'); return; }
      // Hash the new PIN
      const encoder = new TextEncoder();
      const hashBuffer = await crypto.subtle.digest('SHA-256', encoder.encode(v));
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      const { error } = await supabase.from('config').update({ pin_hash: hashHex }).eq('id', 1);
      if (error) { toast('Error updating PIN: '+error.message, 'err'); return; }
      toast('Password updated successfully');
      addActivity('Admin password changed');
    }

    // ===== EXPORT (unchanged, uses DB cache) =====
    function getExportData(type) { /* identical to original */ }
    function downloadCSV(headers, rows, filename) { /* identical */ }
    function downloadPDF(title, headers, rows, filename) { /* identical */ }
    function doExport(type, format) { /* identical */ }

    // ===== INIT =====
    document.getElementById('ci_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('co_date').value = new Date().toISOString().split('T')[0];
    renderResNotices();

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(m=>{
      m.addEventListener('click',function(e){if(e.target===m) m.classList.remove('show');});
    });

    // (Optional) Remove Google Sheets settings from UI if desired
    // But you can keep them ‚Äì they just won't do anything.
  </script>
</body>
</html>
