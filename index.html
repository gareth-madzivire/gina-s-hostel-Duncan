<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResidentHub - Student Accommodation</title>
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700;800&family=Nunito+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
:root{--pri:#1B4332;--pri-l:#2D6A4F;--pri-d:#081C15;--acc:#E6A817;--acc-l:#F5CB5C;--acc-d:#B8860B;--err:#DC2626;--err-l:#FEE2E2;--suc:#059669;--suc-l:#D1FAE5;--warn:#D97706;--warn-l:#FEF3C7;--info:#2563EB;--info-l:#DBEAFE;--bg:#F8F6F0;--bg2:#EFEDE6;--bg3:#E5E2DA;--card:#FFFFFF;--card2:#F5F3ED;--txt:#1A1A1A;--txt2:#4A4A4A;--txt3:#7A7A7A;--brd:#D4D0C8;--shd:0 2px 12px rgba(0,0,0,.08);--shd2:0 4px 24px rgba(0,0,0,.12);--rad:10px;--rad2:16px;--trans:all .25s ease;--room-blue:#3B82F6;--room-gold:#D97706;--room-ensuite:#7C3AED;--room-crystal:#0D9488}
html.dark{--pri:#4ADE80;--pri-l:#6EE7A0;--pri-d:#22C55E;--acc:#F5CB5C;--acc-l:#FDE68A;--acc-d:#E6A817;--bg:#0F1117;--bg2:#1A1D27;--bg3:#252833;--card:#1E2130;--card2:#252839;--txt:#E8E8E8;--txt2:#B0B0B0;--txt3:#787878;--brd:#333648;--shd:0 2px 12px rgba(0,0,0,.3);--shd2:0 4px 24px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden;font-size:15px}
h1,h2,h3,h4,h5{font-family:'Bricolage Grotesque',sans-serif;color:var(--txt);font-weight:700}
.topbar{background:var(--pri-d);color:#fff;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
html.dark .topbar{background:#161822;border-bottom:1px solid var(--brd)}
.topbar .logo{font-family:'Bricolage Grotesque',sans-serif;font-size:1.2rem;font-weight:800;display:flex;align-items:center;gap:8px}
.topbar .logo i{color:var(--acc);font-size:1rem}
.topbar .mode-tabs{display:flex;gap:4px;background:rgba(255,255,255,.1);border-radius:8px;padding:3px}
.topbar .mode-tab{padding:6px 14px;border-radius:6px;cursor:pointer;font-size:.82rem;font-weight:600;color:rgba(255,255,255,.7);transition:var(--trans);border:none;background:none}
.topbar .mode-tab.active{background:var(--acc);color:var(--pri-d)}
html.dark .topbar .mode-tab.active{color:#000}
.db-indicator{font-size:.65rem;padding:2px 8px;border-radius:10px;margin-left:6px;font-weight:700}
.db-indicator.online{background:var(--suc-l);color:var(--suc)}
.db-indicator.offline{background:var(--warn-l);color:var(--warn)}
.container{max-width:960px;margin:0 auto;padding:16px}
.section{display:none}.section.active{display:block}
.page-title{font-size:1.5rem;margin-bottom:6px}
.page-sub{color:var(--txt3);margin-bottom:20px;font-size:.9rem}
.card{background:var(--card);border-radius:var(--rad2);padding:20px;box-shadow:var(--shd);border:1px solid var(--brd);margin-bottom:16px;transition:var(--trans)}
.card:hover{box-shadow:var(--shd2)}
.card-h{font-size:1.05rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.card-h i{color:var(--acc);font-size:1rem}
.nav-pills{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--brd)}
.pill{padding:6px 12px;border-radius:20px;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--txt2);background:var(--bg2);border:1px solid var(--brd);transition:var(--trans)}
.pill.active{background:var(--pri);color:#fff;border-color:var(--pri)}
html.dark .pill.active{color:#000}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-weight:600;font-size:.84rem;margin-bottom:4px;color:var(--txt2)}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid var(--brd);border-radius:var(--rad);background:var(--card);color:var(--txt);font-size:16px;font-family:inherit;transition:var(--trans)}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(27,67,50,.12)}
html.dark .form-group input:focus,html.dark .form-group select:focus,html.dark .form-group textarea:focus{box-shadow:0 0 0 3px rgba(74,222,128,.15)}
.form-group textarea{resize:vertical;min-height:80px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.btn{padding:10px 18px;border:none;border-radius:var(--rad);font-family:inherit;font-weight:600;font-size:.88rem;cursor:pointer;transition:var(--trans);display:inline-flex;align-items:center;gap:6px}
.btn-pri{background:var(--pri);color:#fff}.btn-pri:hover{background:var(--pri-l)}
html.dark .btn-pri{color:#000}
.btn-acc{background:var(--acc);color:var(--pri-d)}.btn-acc:hover{background:var(--acc-l)}
.btn-err{background:var(--err);color:#fff}.btn-err:hover{opacity:.85}
.btn-out{background:transparent;border:1.5px solid var(--brd);color:var(--txt2)}.btn-out:hover{border-color:var(--pri);color:var(--pri)}
.btn-wa{background:#25D366;color:#fff}.btn-wa:hover{background:#1DA851}
.btn-sm{padding:6px 12px;font-size:.76rem}
.btn:disabled{opacity:.5;cursor:not-allowed}
.badge{display:inline-block;padding:3px 9px;border-radius:12px;font-size:.7rem;font-weight:700}
.badge-suc{background:var(--suc-l);color:var(--suc)}
.badge-err{background:var(--err-l);color:var(--err)}
.badge-warn{background:var(--warn-l);color:var(--warn)}
.badge-pri{background:rgba(27,67,50,.1);color:var(--pri)}
.badge-info{background:var(--info-l);color:var(--info)}
html.dark .badge-pri{background:rgba(74,222,128,.15)}
html.dark .badge-info{background:rgba(37,99,235,.2)}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--card);border-radius:var(--rad);padding:14px;text-align:center;border:1px solid var(--brd);box-shadow:var(--shd)}
.stat-card .num{font-family:'Bricolage Grotesque',sans-serif;font-size:1.7rem;font-weight:800;color:var(--pri)}
.stat-card .lbl{font-size:.75rem;color:var(--txt3);margin-top:2px}
.tbl-wrap{overflow-x:auto;border-radius:var(--rad);border:1px solid var(--brd)}
.tbl{width:100%;border-collapse:collapse;font-size:.8rem}
.tbl th{background:var(--bg2);font-weight:700;text-align:left;padding:10px 12px;color:var(--txt2);white-space:nowrap;font-size:.72rem;text-transform:uppercase;letter-spacing:.5px}
.tbl td{padding:9px 12px;border-top:1px solid var(--brd);vertical-align:middle}
.tbl tr:hover td{background:var(--card2)}
.search-bar{position:relative;margin-bottom:14px}
.search-bar input{padding-left:36px}
.search-bar i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--txt3)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:var(--rad2);padding:24px;max-width:520px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:var(--shd2);animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-h{font-size:1.1rem;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--txt3);padding:4px}
.toast-container{position:fixed;top:70px;right:16px;z-index:300;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:var(--rad);color:#fff;font-size:.84rem;font-weight:600;animation:toastIn .3s ease;box-shadow:var(--shd2);max-width:320px}
.toast-suc{background:var(--suc)}.toast-err{background:var(--err)}.toast-warn{background:var(--warn)}.toast-info{background:var(--info)}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.rules-box{max-height:300px;overflow-y:auto;background:var(--card2);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:14px;font-size:.84rem;line-height:1.7}
.rules-box h4{margin:12px 0 6px;color:var(--pri)}
.rules-box ol,.rules-box ul{padding-left:20px}
.check-row{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.check-row input[type=checkbox]{width:20px;height:20px;accent-color:var(--pri)}
.empty-state{text-align:center;padding:40px 20px;color:var(--txt3)}
.empty-state i{font-size:2.5rem;margin-bottom:10px;opacity:.4}
.empty-state p{font-size:.9rem}
.admin-login-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
.admin-login-card{max-width:380px;width:100%;text-align:center}
.admin-login-card .lock-icon{width:70px;height:70px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:1.6rem;color:var(--pri)}
.auth-input{margin-bottom:8px;text-align:left}
.lockout-msg{color:var(--err);font-size:.82rem;margin-top:8px;font-weight:600}
.attempt-counter{font-size:.75rem;color:var(--txt3);margin-top:6px}
.room-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.room-card{border-radius:var(--rad2);padding:18px;border:2px solid var(--brd);transition:var(--trans);position:relative;overflow:hidden}
.room-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.room-card.blue-white::before{background:linear-gradient(90deg,#3B82F6,#fff)}
.room-card.black-gold::before{background:linear-gradient(90deg,#1F2937,#D97706)}
.room-card.ensuite::before{background:linear-gradient(90deg,#7C3AED,#A78BFA)}
.room-card.crystal-1::before,.room-card.crystal-2::before{background:linear-gradient(90deg,#0D9488,#5EEAD4)}
.room-card .room-name{font-family:'Bricolage Grotesque',sans-serif;font-weight:700;font-size:1rem;margin-bottom:4px}
.room-card .room-cap{font-size:.78rem;color:var(--txt3);margin-bottom:10px}
.bed-dots{display:flex;gap:6px;margin-bottom:10px}
.bed-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;border:2px solid var(--brd)}
.bed-dot.taken{background:var(--err-l);border-color:var(--err);color:var(--err)}
.bed-dot.open{background:var(--suc-l);border-color:var(--suc);color:var(--suc)}
.occupant-list{font-size:.78rem;color:var(--txt2)}
.occupant-list div{padding:3px 0;border-bottom:1px solid var(--brd)}
.occupant-list div:last-child{border:none}
.notice-card{border-left:4px solid var(--acc)}
.notice-card .notice-date{font-size:.73rem;color:var(--txt3)}
.notice-card .notice-title{font-weight:700;margin:4px 0}
.tab-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.honeypot{position:absolute;left:-9999px;opacity:0;height:0}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .35s ease}
.settings-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--brd)}
.settings-row:last-child{border:none}
.settings-row label{flex:1;font-weight:600;font-size:.86rem}
.settings-row input{flex:2}
.export-section{margin-bottom:24px}
.export-section h4{margin-bottom:10px;font-size:.95rem}
.export-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.strength-bar{height:4px;border-radius:2px;background:var(--bg3);margin-top:6px;overflow:hidden}
.strength-bar div{height:100%;border-radius:2px;transition:width .3s ease}
.security-info{background:var(--card2);border:1px solid var(--brd);border-radius:var(--rad);padding:14px;margin-top:12px;font-size:.8rem;line-height:1.6}
.security-info h5{margin-bottom:6px;color:var(--pri)}
.wa-notice{background:rgba(37,211,102,.08);border:1px solid rgba(37,211,102,.3);border-radius:var(--rad);padding:10px 14px;margin-top:10px;font-size:.82rem;display:flex;align-items:center;gap:8px;color:var(--txt2)}
.wa-notice i{color:#25D366;font-size:1rem}
.session-timer{font-size:.7rem;color:var(--txt3);margin-left:auto}
.sql-code{background:var(--bg2);border:1px solid var(--brd);border-radius:var(--rad);padding:12px;font-family:monospace;font-size:.72rem;white-space:pre-wrap;max-height:250px;overflow-y:auto;margin:8px 0;color:var(--txt)}
</style>
</head>
<body>
<div class="topbar">
  <div class="logo"><i class="fas fa-building-user"></i> ResidentHub <span class="db-indicator online" id="dbStatus">SUPABASE</span></div>
  <div class="mode-tabs">
    <button class="mode-tab active" onclick="switchMode('resident')">Resident</button>
    <button class="mode-tab" onclick="switchMode('admin')">Admin</button>
  </div>
</div>
<div class="toast-container" id="toasts"></div>

<!-- ===== RESIDENT PORTAL (unchanged) ===== -->
<div id="residentPortal" class="container section active">
  <nav class="nav-pills" id="resNavPills">
    <button class="pill active" data-tab="res-checkin"><i class="fas fa-right-to-bracket"></i> Check-In</button>
    <button class="pill" data-tab="res-rules"><i class="fas fa-scroll"></i> Rules</button>
    <button class="pill" data-tab="res-maintenance"><i class="fas fa-wrench"></i> Maintenance</button>
    <button class="pill" data-tab="res-incident"><i class="fas fa-triangle-exclamation"></i> Incident</button>
    <button class="pill" data-tab="res-checkout"><i class="fas fa-arrow-right-from-bracket"></i> Check-Out</button>
    <button class="pill" data-tab="res-notices"><i class="fas fa-bullhorn"></i> Notices</button>
  </nav>

  <!-- CHECK-IN -->
  <div id="res-checkin" class="res-tab active fade-in">
    <h2 class="page-title">Check-In Registration</h2>
    <p class="page-sub">Welcome! Complete the form below to register your arrival. Full capacity: 13 residents across 5 rooms.</p>
    <div class="card">
      <form id="checkinForm" onsubmit="return handleCheckin(event)">
        <input type="text" name="hp_field" class="honeypot" tabindex="-1" autocomplete="off">
        <div class="form-row">
          <div class="form-group"><label>Full Name *</label><input type="text" id="ci_name" required minlength="2" maxlength="100"></div>
          <div class="form-group"><label>Phone Number *</label><input type="tel" id="ci_phone" required pattern="[0-9+\-\s]{7,15}"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Institution / University</label><input type="text" id="ci_institution" maxlength="100"></div>
          <div class="form-group"><label>ID / Passport Number *</label><input type="text" id="ci_id" required maxlength="20"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Room *</label><select id="ci_room" required></select></div>
          <div class="form-group"><label>Check-In Date *</label><input type="date" id="ci_date" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Resident Status</label><select id="ci_status"><option value="New">New Resident</option><option value="Returning">Returning Resident</option></select></div>
          <div class="form-group"><label>Deposit Status</label><select id="ci_deposit"><option value="Paid">Paid</option><option value="Pending">Pending</option><option value="Partial">Partial</option></select></div>
        </div>
        <div class="form-group"><label>Additional Notes</label><textarea id="ci_notes" rows="2" placeholder="Any special requirements..." maxlength="500"></textarea></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-check"></i> Submit Check-In</button>
      </form>
    </div>
  </div>

  <!-- RULES -->
  <div id="res-rules" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">House Rules &amp; Agreement</h2>
    <p class="page-sub">Please read the rules carefully and accept to proceed.</p>
    <div class="card">
      <div class="rules-box">
        <h4>1. General Conduct</h4>
        <ol>
          <li>All residents must treat each other, staff, and property with respect.</li>
          <li>Noise must be kept to acceptable levels, especially between 22:00 and 06:00.</li>
          <li>No illegal substances, weapons, or dangerous items are permitted on the premises.</li>
          <li>Visitors must be signed in and out at reception and are not permitted overnight without prior approval.</li>
        </ol>
        <h4>2. Room &amp; Property Care</h4>
        <ol>
          <li>Residents are responsible for keeping their rooms clean and tidy.</li>
          <li>No alterations may be made to rooms (painting, drilling, etc.) without written permission.</li>
          <li>Any damage must be reported immediately and may result in charges.</li>
          <li>Room inspections may be conducted with 24 hours' notice.</li>
        </ol>
        <h4>3. Safety &amp; Security</h4>
        <ol>
          <li>Doors must be locked when leaving. Lost keys must be reported immediately (replacement fee applies).</li>
          <li>Fire exits must remain clear. Tampering with safety equipment is a serious offence.</li>
          <li>Report suspicious activity or safety concerns to management immediately.</li>
        </ol>
        <h4>4. Payments &amp; Utilities</h4>
        <ol>
          <li>Rent is due on the 1st of each month. Late payments incur a penalty.</li>
          <li>Electricity and water are shared resources â€” excessive usage may be individually billed.</li>
          <li>Deposits are refundable upon satisfactory room inspection at check-out.</li>
        </ol>
        <h4>5. Check-Out Procedures</h4>
        <ol>
          <li>Written notice of departure must be given at least 14 days in advance.</li>
          <li>All keys must be returned. Room must be cleaned and cleared of personal belongings.</li>
          <li>A final inspection will be conducted before deposit refund processing.</li>
        </ol>
      </div>
      <form id="rulesForm" onsubmit="return handleRulesAccept(event)">
        <div class="form-row">
          <div class="form-group"><label>Your Full Name *</label><input type="text" id="ra_name" required></div>
          <div class="form-group"><label>Room *</label><select id="ra_room" required></select></div>
        </div>
        <div class="check-row">
          <input type="checkbox" id="ra_accept" required>
          <label for="ra_accept" style="font-size:.86rem">I have read, understood, and agree to abide by all house rules above. <strong>(Rules v1.0)</strong></label>
        </div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-file-signature"></i> Accept Rules</button>
      </form>
    </div>
  </div>

  <!-- MAINTENANCE -->
  <div id="res-maintenance" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Maintenance Request</h2>
    <p class="page-sub">Report an issue that needs fixing in your room or common areas.</p>
    <div class="card">
      <form id="maintenanceForm" onsubmit="return handleMaintenance(event)">
        <div class="form-row">
          <div class="form-group"><label>Your Name *</label><input type="text" id="mt_name" required></div>
          <div class="form-group"><label>Room *</label><select id="mt_room" required></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Category *</label>
            <select id="mt_category" required><option value="">Select Category</option><option>Plumbing</option><option>Electrical</option><option>Furniture</option><option>Doors/Windows</option><option>Appliances</option><option>Pest Control</option><option>Common Area</option><option>Other</option></select>
          </div>
          <div class="form-group"><label>Urgency *</label>
            <select id="mt_urgency" required><option value="Low">Low - Can wait</option><option value="Medium">Medium - Soon</option><option value="High">High - Urgent</option><option value="Critical">Critical - Emergency</option></select>
          </div>
        </div>
        <div class="form-group"><label>Description *</label><textarea id="mt_desc" required placeholder="Describe the issue in detail..." maxlength="1000"></textarea></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-paper-plane"></i> Submit Request</button>
      </form>
    </div>
  </div>

  <!-- INCIDENT -->
  <div id="res-incident" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Incident Report</h2>
    <p class="page-sub">Report safety, hygiene, noise, theft, or conflict incidents.</p>
    <div class="card">
      <form id="incidentForm" onsubmit="return handleIncident(event)">
        <div class="form-row">
          <div class="form-group"><label>Your Name *</label><input type="text" id="in_name" required></div>
          <div class="form-group"><label>Room *</label><select id="in_room" required></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Incident Type *</label>
            <select id="in_type" required><option value="">Select Type</option><option>Safety</option><option>Hygiene</option><option>Noise</option><option>Theft</option><option>Conflict</option><option>Property Damage</option><option>Other</option></select>
          </div>
          <div class="form-group"><label>Urgency *</label>
            <select id="in_urgency" required><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option><option value="Critical">Critical</option></select>
          </div>
        </div>
        <div class="form-group"><label>Description *</label><textarea id="in_desc" required placeholder="Describe the incident in detail..." maxlength="2000"></textarea></div>
        <div class="wa-notice"><i class="fab fa-whatsapp"></i> Submitting will also send this report to the admin via WhatsApp for immediate attention.</div>
        <div style="margin-top:14px"><button type="submit" class="btn btn-pri"><i class="fas fa-flag"></i> Submit &amp; Notify Admin</button></div>
      </form>
    </div>
  </div>

  <!-- CHECK-OUT -->
  <div id="res-checkout" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Check-Out Form</h2>
    <p class="page-sub">Complete this form when you are ready to vacate your room.</p>
    <div class="card">
      <form id="checkoutForm" onsubmit="return handleCheckout(event)">
        <div class="form-row">
          <div class="form-group"><label>Full Name *</label><input type="text" id="co_name" required></div>
          <div class="form-group"><label>Room *</label><select id="co_room" required></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Check-Out Date *</label><input type="date" id="co_date" required></div>
          <div class="form-group"><label>Key Returned? *</label><select id="co_key" required><option value="Yes">Yes</option><option value="No">No</option></select></div>
        </div>
        <div class="form-group"><label>Room Condition Notes</label><textarea id="co_condition" placeholder="Describe room condition..." maxlength="500"></textarea></div>
        <div class="form-group"><label>Forwarding Contact (Phone/Email)</label><input type="text" id="co_forward" maxlength="100"></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-door-open"></i> Submit Check-Out</button>
      </form>
    </div>
  </div>

  <!-- NOTICES -->
  <div id="res-notices" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Notices &amp; Announcements</h2>
    <p class="page-sub">Important updates from management.</p>
    <div id="resNoticesList"></div>
  </div>
</div>

<!-- ===== ADMIN PORTAL (Supabase Auth) ===== -->
<div id="adminPortal" class="container section">
  <div id="adminLogin" class="admin-login-wrap">
    <div class="card admin-login-card">
      <div class="lock-icon"><i class="fas fa-shield-halved"></i></div>
      <h2 class="page-title" style="margin-bottom:6px">Admin Access</h2>
      <p class="page-sub">Sign in with your Supabase account</p>
      <form onsubmit="return handleAdminLogin(event)">
        <div class="form-group auth-input">
          <label>Email</label>
          <input type="email" id="adminEmail" required placeholder="admin@example.com">
        </div>
        <div class="form-group auth-input">
          <label>Password</label>
          <input type="password" id="adminPassword" required>
        </div>
        <button type="submit" class="btn btn-pri" id="loginBtn" style="width:100%;justify-content:center"><i class="fas fa-sign-in-alt"></i> Sign In</button>
        <div class="lockout-msg" id="lockoutMsg" style="display:none"></div>
        <div class="attempt-counter" id="attemptCounter"></div>
      </form>
      <p style="margin-top:12px;font-size:.72rem;color:var(--txt3)">Use a user created in Supabase Auth.</p>
    </div>
  </div>

  <div id="adminDash" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:14px">
      <div>
        <h2 class="page-title">Admin Dashboard</h2>
        <p class="page-sub" style="margin:0">Manage residents, payments, and operations.</p>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="session-timer" id="sessionTimer"></span>
        <button class="btn btn-out btn-sm" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <nav class="nav-pills" id="adminNavPills">
      <button class="pill active" data-tab="adm-overview"><i class="fas fa-chart-pie"></i> Overview</button>
      <button class="pill" data-tab="adm-residents"><i class="fas fa-users"></i> Residents</button>
      <button class="pill" data-tab="adm-rooms"><i class="fas fa-door-closed"></i> Rooms</button>
      <button class="pill" data-tab="adm-payments"><i class="fas fa-money-bill"></i> Payments</button>
      <button class="pill" data-tab="adm-utilities"><i class="fas fa-bolt"></i> Utilities</button>
      <button class="pill" data-tab="adm-incidents"><i class="fas fa-flag"></i> Incidents</button>
      <button class="pill" data-tab="adm-notices"><i class="fas fa-bullhorn"></i> Notices</button>
      <button class="pill" data-tab="adm-exports"><i class="fas fa-download"></i> Exports</button>
      <button class="pill" data-tab="adm-settings"><i class="fas fa-cog"></i> Settings</button>
    </nav>

    <!-- OVERVIEW -->
    <div id="adm-overview" class="adm-tab active fade-in">
      <div class="stat-grid" id="statsGrid"></div>
      <div class="card"><div class="card-h"><i class="fas fa-clock"></i> Recent Activity</div><div id="activityLog"></div></div>
    </div>

    <!-- RESIDENTS -->
    <div id="adm-residents" class="adm-tab fade-in" style="display:none">
      <div class="tab-actions">
        <button class="btn btn-pri btn-sm" onclick="openModal('addResidentModal')"><i class="fas fa-plus"></i> Add Resident</button>
      </div>
      <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="residentSearch" placeholder="Search by name, room, status..." oninput="renderResidents()"></div>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Name</th><th>Room</th><th>Phone</th><th>Status</th><th>Payment</th><th>Actions</th></tr></thead><tbody id="residentsBody"></tbody></table></div>
    </div>

    <!-- ROOMS -->
    <div id="adm-rooms" class="adm-tab fade-in" style="display:none">
      <div style="display:flex;gap:16px;margin-bottom:14px;font-size:.8rem;flex-wrap:wrap">
        <span><span class="bed-dot open" style="display:inline-flex;width:16px;height:16px;font-size:0"></span> Available Bed</span>
        <span><span class="bed-dot taken" style="display:inline-flex;width:16px;height:16px;font-size:0"></span> Occupied Bed</span>
        <span style="margin-left:auto;color:var(--txt3)">Total Capacity: <strong>13 beds</strong></span>
      </div>
      <div class="room-cards" id="roomGrid"></div>
    </div>

    <!-- PAYMENTS -->
    <div id="adm-payments" class="adm-tab fade-in" style="display:none">
      <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addPaymentModal')"><i class="fas fa-plus"></i> Record Payment</button></div>
      <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="paymentSearch" placeholder="Search payments..." oninput="renderPayments()"></div>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>Resident</th><th>Month</th><th>Amount</th><th>Balance</th><th>Method</th><th>Ref</th></tr></thead><tbody id="paymentsBody"></tbody></table></div>
    </div>

    <!-- UTILITIES -->
    <div id="adm-utilities" class="adm-tab fade-in" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button class="btn btn-out btn-sm util-tab active" data-util="power" onclick="switchUtilTab('power')"><i class="fas fa-bolt"></i> Electricity</button>
        <button class="btn btn-out btn-sm util-tab" data-util="water" onclick="switchUtilTab('water')"><i class="fas fa-droplet"></i> Water</button>
      </div>
      <div id="util-power">
        <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addPowerModal')"><i class="fas fa-plus"></i> Add Recharge</button></div>
        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>Units</th><th>Amount (USD)</th><th>Balance After</th><th>Notes</th></tr></thead><tbody id="powerBody"></tbody></table></div>
      </div>
      <div id="util-water" style="display:none">
        <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addWaterModal')"><i class="fas fa-plus"></i> Add Delivery</button></div>
        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>Litres</th><th>Supplier</th><th>Cost</th><th>Tank Filled</th><th>Notes</th></tr></thead><tbody id="waterBody"></tbody></table></div>
      </div>
    </div>

    <!-- INCIDENTS -->
    <div id="adm-incidents" class="adm-tab fade-in" style="display:none">
      <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="incidentSearch" placeholder="Search incidents..." oninput="renderIncidents()"></div>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>By</th><th>Room</th><th>Type</th><th>Urgency</th><th>Status</th><th>Actions</th></tr></thead><tbody id="incidentsBody"></tbody></table></div>
    </div>

    <!-- NOTICES -->
    <div id="adm-notices" class="adm-tab fade-in" style="display:none">
      <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addNoticeModal')"><i class="fas fa-plus"></i> Post Notice</button></div>
      <div id="adminNoticesList"></div>
    </div>

    <!-- EXPORTS -->
    <div id="adm-exports" class="adm-tab fade-in" style="display:none">
      <div class="export-section">
        <h4><i class="fas fa-file-csv" style="color:var(--suc)"></i> Export as CSV</h4>
        <div class="export-grid">
          <button class="btn btn-out btn-sm" onclick="exportCSV('residents')"><i class="fas fa-users"></i> Residents</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('payments')"><i class="fas fa-money-bill"></i> Payments</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('incidents')"><i class="fas fa-flag"></i> Incidents</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('checkins')"><i class="fas fa-right-to-bracket"></i> Check-Ins</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('checkouts')"><i class="fas fa-door-open"></i> Check-Outs</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('maintenance')"><i class="fas fa-wrench"></i> Maintenance</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('power')"><i class="fas fa-bolt"></i> Electricity</button>
          <button class="btn btn-out btn-sm" onclick="exportCSV('water')"><i class="fas fa-droplet"></i> Water</button>
        </div>
      </div>
      <div class="export-section">
        <h4><i class="fas fa-file-pdf" style="color:var(--err)"></i> Export as PDF</h4>
        <div class="export-grid">
          <button class="btn btn-out btn-sm" onclick="exportPDF('residents')"><i class="fas fa-users"></i> Residents</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('payments')"><i class="fas fa-money-bill"></i> Payments</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('incidents')"><i class="fas fa-flag"></i> Incidents</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('checkins')"><i class="fas fa-right-to-bracket"></i> Check-Ins</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('checkouts')"><i class="fas fa-door-open"></i> Check-Outs</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('maintenance')"><i class="fas fa-wrench"></i> Maintenance</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('power')"><i class="fas fa-bolt"></i> Electricity</button>
          <button class="btn btn-out btn-sm" onclick="exportPDF('water')"><i class="fas fa-droplet"></i> Water</button>
        </div>
      </div>
      <div class="export-section">
        <h4><i class="fas fa-layer-group" style="color:var(--info)"></i> Combined Reports</h4>
        <div class="export-grid">
          <button class="btn btn-acc btn-sm" onclick="exportCombinedCSV()"><i class="fas fa-file-csv"></i> All Data CSV</button>
          <button class="btn btn-acc btn-sm" onclick="exportCombinedPDF()"><i class="fas fa-file-pdf"></i> All Data PDF</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS (simplified) -->
    <div id="adm-settings" class="adm-tab fade-in" style="display:none">
      <div class="card">
        <div class="card-h"><i class="fas fa-shield-halved"></i> Security Settings</div>
        <div class="settings-row">
          <label>WhatsApp Admin Number</label>
          <input type="tel" id="settingWA" value="263771308790">
          <button class="btn btn-sm btn-pri" onclick="updateWA()">Save</button>
        </div>
        <div class="security-info">
          <h5><i class="fas fa-lock"></i> Security Features Active</h5>
          <ul style="padding-left:16px;margin:0">
            <li>Brute-force protection: 5 failed attempts = 15min lockout</li>
            <li>Progressive delay: increasing wait between failed attempts</li>
            <li>Session timeout: auto-logout after 30 minutes of inactivity</li>
            <li>Supabase Auth with email/password</li>
            <li>Input sanitization: all user inputs escaped against XSS</li>
            <li>Honeypot fields: spam protection on public forms</li>
            <li>Audit trail: all admin actions logged with timestamps</li>
          </ul>
        </div>
      </div>
      <div class="card">
        <div class="card-h"><i class="fas fa-database"></i> Supabase Status</div>
        <div style="padding:12px 0">
          <p><i class="fas fa-check-circle" style="color:var(--suc)"></i> Connected to Supabase (credentials hardcoded).</p>
          <button class="btn btn-out btn-sm" onclick="testSupabaseConnection()"><i class="fas fa-wifi"></i> Test Connection</button>
        </div>
        <details style="margin-top:14px">
          <summary style="cursor:pointer;font-weight:600;font-size:.84rem;color:var(--pri)"><i class="fas fa-code"></i> Supabase Setup SQL</summary>
          <div class="sql-code">-- Run this SQL in your Supabase SQL Editor to create all tables
...
</div>
        </details>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALS (unchanged) ===== -->
<div class="modal-overlay" id="addResidentModal"><div class="modal">...</div></div>
<div class="modal-overlay" id="addPaymentModal"><div class="modal">...</div></div>
<div class="modal-overlay" id="addPowerModal"><div class="modal">...</div></div>
<div class="modal-overlay" id="addWaterModal"><div class="modal">...</div></div>
<div class="modal-overlay" id="addNoticeModal"><div class="modal">...</div></div>
<div class="modal-overlay" id="confirmModal"><div class="modal">...</div></div>
<div class="modal-overlay" id="viewIncidentModal"><div class="modal">...</div></div>

<script>
/* ===== SUPABASE INIT (hardcoded) ===== */
var SUPABASE_URL = 'https://lfnpairvlaqawpnjszwt.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmbnBhaXJ2bGFxYXdwbmpzend0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODU1NTksImV4cCI6MjA4NjY2MTU1OX0.36pRAxOrTTt1f2WWnSh2c-j3wB8KFBRLhnc3QL5J7C0';
var supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DARK MODE, ROOMS, DATA STORE (unchanged) ===== */
if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){document.documentElement.classList.add('dark')}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(e){e.matches?document.documentElement.classList.add('dark'):document.documentElement.classList.remove('dark')});

var ROOMS = [
  { id: 'blue-white', name: 'Blue-White', capacity: 3, css: 'blue-white' },
  { id: 'black-gold', name: 'Black-Gold', capacity: 3, css: 'black-gold' },
  { id: 'ensuite', name: 'Ensuite', capacity: 3, css: 'ensuite' },
  { id: 'crystal-1', name: 'Crystal 1', capacity: 2, css: 'crystal-1' },
  { id: 'crystal-2', name: 'Crystal 2', capacity: 2, css: 'crystal-2' }
];
var TOTAL_CAPACITY = 13;
var ADMIN_WA = '263771308790';

var DB = {
  residents: [], checkins: [], checkouts: [], rulesAcceptance: [],
  payments: [], incidents: [], maintenance: [], power: [], water: [],
  notices: [
    { id: 'n1', title: 'Welcome to the New Semester', content: 'We are excited to welcome all residents. Please complete your check-in and rules acceptance within 48 hours of arrival.', priority: 'Important', createdAt: '2025-01-15T08:00:00' },
    { id: 'n2', title: 'Water Schedule Update', content: 'Water deliveries are on Tuesdays and Fridays. Plan usage accordingly and report leaks immediately.', priority: 'Normal', createdAt: '2025-01-20T10:30:00' }
  ],
  activity: []
};
var idCounters = { resident:100,payment:200,incident:300,maintenance:400,power:500,water:600,notice:700,checkin:800,checkout:900,rules:1000 };
var adminLoggedIn = false;
var sessionTimeout = null;
var sessionStart = 0;
var SESSION_DURATION = 30 * 60 * 1000; // 30 minutes
var loginAttempts = 0;
var lockoutUntil = 0;

function nextId(type) { return type.charAt(0).toUpperCase() + (++idCounters[type]); }
function now() { return new Date().toISOString(); }
function fmtDate(iso) { if(!iso)return'-'; return new Date(iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
function fmtDateTime(iso) { if(!iso)return'-'; return new Date(iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function addActivity(msg) { DB.activity.unshift({msg:msg,time:now()}); if(DB.activity.length>50)DB.activity.pop(); }
function esc(str) { var d=document.createElement('div'); d.textContent=str||''; return d.innerHTML; }
function getRoomName(id) { var r=ROOMS.find(function(x){return x.id===id}); return r?r.name:id; }

/* ===== SUPABASE HELPERS (unchanged) ===== */
function isSupabaseConnected() { return supabaseClient !== null; }

async function testSupabaseConnection() {
  try {
    var { data, error } = await supabaseClient.from('residents').select('count', { count: 'exact', head: true });
    if(error) throw error;
    toast('Supabase connection OK!', 'suc');
  } catch(err) {
    toast('Connection test failed: ' + err.message, 'err');
  }
}

async function loadAllFromSupabase() {
  try {
    var tables = [
      {key:'residents',table:'residents'},
      {key:'checkins',table:'checkins'},
      {key:'checkouts',table:'checkouts'},
      {key:'payments',table:'payments'},
      {key:'incidents',table:'incidents'},
      {key:'maintenance',table:'maintenance'},
      {key:'power',table:'power_utilities'},
      {key:'water',table:'water_utilities'},
      {key:'notices',table:'notices'}
    ];
    for(var i=0;i<tables.length;i++) {
      var t = tables[i];
      var resp = await supabaseClient.from(t.table).select('*');
      if(resp.data) DB[t.key] = mapFromSupabase(t.key, resp.data);
    }
    toast('Data loaded from Supabase', 'info');
    renderResNotices();
    if(adminLoggedIn) refreshAdminTab('adm-overview');
  } catch(err) { toast('Failed to load data: '+err.message,'err'); }
}

function mapFromSupabase(key, data) {
  if(key==='incidents') return data.map(function(r){return{id:r.id,submittedBy:r.submitted_by,room:r.room,type:r.type,urgency:r.urgency,description:r.description,status:r.status,adminNotes:r.admin_notes,createdAt:r.created_at,closedAt:r.closed_at}});
  if(key==='checkouts') return data.map(function(r){return{id:r.id,name:r.name,room:r.room,date:r.date,keyReturned:r.key_returned,condition:r.condition_notes,forwardContact:r.forward_contact,createdAt:r.created_at}});
  if(key==='payments') return data.map(function(r){return{id:r.id,name:r.name,month:r.month,amount:r.amount,balance:r.balance,method:r.method,ref:r.ref,notes:r.notes,paidDate:r.paid_date,recordedBy:r.recorded_by}});
  if(key==='residents') return data.map(function(r){return{id:r.id,name:r.name,phone:r.phone,institution:r.institution,idNumber:r.id_number,room:r.room,status:r.status,checkinDate:r.checkin_date,paymentStatus:r.payment_status,notes:r.notes,createdAt:r.created_at}});
  if(key==='checkins') return data.map(function(r){return{id:r.id,name:r.name,phone:r.phone,institution:r.institution,idNumber:r.id_number,room:r.room,date:r.date,status:r.status,deposit:r.deposit,notes:r.notes,createdAt:r.created_at}});
  if(key==='notices') return data.map(function(r){return{id:r.id,title:r.title,content:r.content,priority:r.priority,createdAt:r.created_at}});
  if(key==='power') return data.map(function(r){return{id:r.id,date:r.date,units:r.units,amount:r.amount,balance:r.balance,notes:r.notes}});
  if(key==='water') return data.map(function(r){return{id:r.id,date:r.date,litres:r.litres,supplier:r.supplier,cost:r.cost,filled:r.filled,notes:r.notes}});
  return data;
}

async function sbInsert(table, row) {
  try { await supabaseClient.from(table).insert(row); }
  catch(err) { console.log('Supabase insert error: '+err.message); }
}
async function sbUpdate(table, id, updates) {
  try { await supabaseClient.from(table).update(updates).eq('id',id); }
  catch(err) { console.log('Supabase update error: '+err.message); }
}
async function sbDelete(table, id) {
  try { await supabaseClient.from(table).delete().eq('id',id); }
  catch(err) { console.log('Supabase delete error: '+err.message); }
}

/* ===== TOAST, MODAL, NAVIGATION, ROOM SELECT, WHATSAPP (unchanged) ===== */
function toast(msg, type) {
  var t=document.createElement('div');
  t.className='toast toast-'+(type||'suc');
  t.textContent=msg;
  document.getElementById('toasts').appendChild(t);
  setTimeout(function(){t.remove()},3500);
}
function openModal(id){document.getElementById(id).classList.add('show')}
function closeModal(id){document.getElementById(id).classList.remove('show')}
function showConfirm(title,msg,onConfirm){
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  var btn=document.getElementById('confirmBtn');
  var nb=btn.cloneNode(true);
  btn.parentNode.replaceChild(nb,btn);
  nb.id='confirmBtn';
  nb.addEventListener('click',function(){closeModal('confirmModal');onConfirm()});
  openModal('confirmModal');
}
function switchMode(mode){
  document.querySelectorAll('.mode-tab').forEach(function(t){t.classList.remove('active')});
  document.querySelectorAll('.section').forEach(function(s){s.classList.remove('active')});
  if(mode==='resident'){
    document.querySelector('.mode-tab:nth-child(1)').classList.add('active');
    document.getElementById('residentPortal').classList.add('active');
  } else {
    document.querySelector('.mode-tab:nth-child(2)').classList.add('active');
    document.getElementById('adminPortal').classList.add('active');
  }
}
function setupTabs(navId, tabClass){
  document.getElementById(navId).addEventListener('click',function(e){
    var pill=e.target.closest('.pill');
    if(!pill)return;
    document.querySelectorAll('#'+navId+' .pill').forEach(function(p){p.classList.remove('active')});
    pill.classList.add('active');
    document.querySelectorAll('.'+tabClass).forEach(function(t){t.style.display='none'});
    var target=document.getElementById(pill.dataset.tab);
    if(target){target.style.display='block'}
    if(tabClass==='adm-tab') refreshAdminTab(pill.dataset.tab);
  });
}
setupTabs('resNavPills','res-tab');
setupTabs('adminNavPills','adm-tab');

function getRoomOptions(){
  var html='<option value="">Select Room</option>';
  ROOMS.forEach(function(r){
    var occ=DB.residents.filter(function(res){return res.room===r.id}).length;
    var avail=r.capacity-occ;
    var label=r.name+' ('+avail+'/'+r.capacity+' available)';
    html+='<option value="'+r.id+'"'+(avail<=0?' disabled':'')+'>'+label+'</option>';
  });
  return html;
}
function populateRoomSelects(){
  var html=getRoomOptions();
  ['ci_room','ra_room','mt_room','in_room','co_room','ar_room'].forEach(function(id){
    var el=document.getElementById(id);
    if(el) el.innerHTML=html;
  });
}
populateRoomSelects();

function sendWhatsApp(incident){
  var roomName=getRoomName(incident.room);
  var msg='*INCIDENT REPORT - ResidentHub*\n\n'+
    'Type: '+incident.type+'\n'+
    'Urgency: '+incident.urgency+'\n'+
    'Room: '+roomName+'\n'+
    'Reported by: '+incident.submittedBy+'\n'+
    'Date: '+fmtDateTime(incident.createdAt)+'\n\n'+
    'Description:\n'+incident.description;
  var url='https://wa.me/'+ADMIN_WA+'?text='+encodeURIComponent(msg);
  window.open(url,'_blank');
}

/* ===== RESIDENT FORMS (unchanged) ===== */
function handleCheckin(e){ /* same as before */ e.preventDefault(); ... }
function handleRulesAccept(e){ /* same */ }
function handleMaintenance(e){ /* same */ }
function handleIncident(e){ /* same, but ensure sendWhatsApp called */ }
function handleCheckout(e){ /* same */ }

/* ===== ADMIN AUTH ===== */
async function handleAdminLogin(e) {
  e.preventDefault();
  var nowMs = Date.now();
  if(nowMs < lockoutUntil) {
    var secs = Math.ceil((lockoutUntil-nowMs)/1000);
    document.getElementById('lockoutMsg').style.display = 'block';
    document.getElementById('lockoutMsg').textContent = 'Too many attempts. Try again in '+secs+' seconds.';
    return false;
  }

  var email = document.getElementById('adminEmail').value.trim();
  var password = document.getElementById('adminPassword').value;

  try {
    var { data, error } = await supabaseClient.auth.signInWithPassword({
      email: email,
      password: password
    });

    if(error) throw error;

    adminLoggedIn = true;
    loginAttempts = 0;
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminDash').style.display = 'block';
    document.getElementById('lockoutMsg').style.display = 'none';
    document.getElementById('attemptCounter').textContent = '';

    startSession();

    addActivity('Admin logged in via Supabase');
    toast('Welcome, Admin!');

    // Load data after login
    loadAllFromSupabase();

    supabaseClient.auth.onAuthStateChange((event, session) => {
      if(event === 'SIGNED_OUT') {
        adminLogout(true);
      }
    });

  } catch(err) {
    loginAttempts++;
    var remaining = 5 - loginAttempts;
    if(loginAttempts >= 5) {
      lockoutUntil = nowMs + 15*60*1000;
      document.getElementById('lockoutMsg').style.display = 'block';
      document.getElementById('lockoutMsg').textContent = 'Too many failed attempts. Locked for 15 minutes.';
      document.getElementById('attemptCounter').textContent = '';
      loginAttempts = 0;
      addActivity('Admin login locked out (5 failed attempts)');
    } else {
      document.getElementById('attemptCounter').textContent = remaining + ' attempt' + (remaining!==1?'s':'') + ' remaining';
      var delay = Math.pow(2, loginAttempts) * 500;
      document.getElementById('loginBtn').disabled = true;
      setTimeout(function(){ document.getElementById('loginBtn').disabled = false; }, delay);
    }
    toast('Login failed: ' + (err.message || 'Invalid credentials'), 'err');
  }

  document.getElementById('adminPassword').value = '';
  return false;
}

function startSession() {
  sessionStart = Date.now();
  resetSessionTimer();
  updateSessionDisplay();
}
function resetSessionTimer() {
  clearTimeout(sessionTimeout);
  sessionStart = Date.now();
  sessionTimeout = setTimeout(function() {
    adminLogout();
    toast('Session expired due to inactivity', 'warn');
  }, SESSION_DURATION);
}
function updateSessionDisplay() {
  if(!adminLoggedIn) return;
  var elapsed = Date.now() - sessionStart;
  var remaining = Math.max(0, SESSION_DURATION - elapsed);
  var mins = Math.floor(remaining / 60000);
  var secs = Math.floor((remaining % 60000) / 1000);
  var el = document.getElementById('sessionTimer');
  if(el) el.textContent = mins + 'm ' + secs + 's';
  if(adminLoggedIn) requestAnimationFrame(updateSessionDisplay);
}
document.addEventListener('click', function(){ if(adminLoggedIn) resetSessionTimer(); });
document.addEventListener('keydown', function(){ if(adminLoggedIn) resetSessionTimer(); });

async function adminLogout(silent = false) {
  if(!silent && supabaseClient) await supabaseClient.auth.signOut();
  adminLoggedIn = false;
  clearTimeout(sessionTimeout);
  document.getElementById('adminLogin').style.display = '';
  document.getElementById('adminDash').style.display = 'none';
  addActivity('Admin logged out');
  toast('Logged out');
}

/* ===== ADMIN RENDER FUNCTIONS (unchanged) ===== */
function refreshAdminTab(tab){ /* same */ }
function renderOverview(){ /* same */ }
function renderResidents(){ /* same */ }
function removeResident(id){ /* same, with sbDelete */ }
function addResidentManual(e){ /* same, with sbInsert */ }
function renderRooms(){ /* same */ }
function renderPayments(){ /* same */ }
function addPayment(e){ /* same */ }
function renderPower(){ /* same */ }
function renderWater(){ /* same */ }
function addPower(e){ /* same */ }
function addWater(e){ /* same */ }
function switchUtilTab(tab){ /* same */ }
function renderIncidents(){ /* same */ }
function urgBadge(u){return u==='Critical'||u==='High'?'err':u==='Medium'?'warn':'suc'}
function statusBadge(s){return s==='Open'?'err':s==='In Progress'?'warn':'suc'}
function viewIncident(id){ /* same */ }
function toggleIncident(id){ /* same, with sbUpdate */ }
function renderAdminNotices(){ /* same */ }
function addNotice(e){ /* same */ }
function removeNotice(id){ /* same, with sbDelete */ }
function renderResNotices(){ /* same */ }

/* ===== SETTINGS ===== */
function updateWA() {
  ADMIN_WA = document.getElementById('settingWA').value.trim().replace(/[^0-9]/g,'');
  toast('WhatsApp number updated to +' + ADMIN_WA);
}

/* ===== CSV/PDF EXPORT (unchanged) ===== */
function getExportData(type){ /* same */ }
function exportCSV(type){ /* same */ }
function exportCombinedCSV(){ /* same */ }
function downloadFile(content,mime,filename){ /* same */ }
function exportPDF(type){ /* same */ }
function exportCombinedPDF(){ /* same */ }
function addPDFHeader(doc,title){ /* same */ }
function addPDFFooter(doc){ /* same */ }

/* ===== INIT ===== */
document.getElementById('ci_date').value = new Date().toISOString().split('T')[0];
document.getElementById('co_date').value = new Date().toISOString().split('T')[0];
renderResNotices();

// Load data on page load (optional)
loadAllFromSupabase();

document.querySelectorAll('.modal-overlay').forEach(function(m){
  m.addEventListener('click',function(e){if(e.target===m)m.classList.remove('show')});
});

// Ensure dashboard tabs are set up after login
// (already done via setupTabs)
</script>
</body>
</html>
