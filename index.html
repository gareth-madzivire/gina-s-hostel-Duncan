<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResidentHub - Student Accommodation</title>
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;700;800&family=Nunito+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
:root{--pri:#1B4332;--pri-l:#2D6A4F;--pri-d:#081C15;--acc:#E6A817;--acc-l:#F5CB5C;--acc-d:#B8860B;--err:#DC2626;--err-l:#FEE2E2;--suc:#059669;--suc-l:#D1FAE5;--warn:#D97706;--warn-l:#FEF3C7;--bg:#F8F6F0;--bg2:#EFEDE6;--bg3:#E5E2DA;--card:#FFFFFF;--card2:#F5F3ED;--txt:#1A1A1A;--txt2:#4A4A4A;--txt3:#7A7A7A;--brd:#D4D0C8;--shd:0 2px 12px rgba(0,0,0,.08);--shd2:0 4px 24px rgba(0,0,0,.12);--rad:10px;--rad2:16px;--trans:all .25s ease}
html.dark{--pri:#4ADE80;--pri-l:#6EE7A0;--pri-d:#22C55E;--acc:#F5CB5C;--acc-l:#FDE68A;--acc-d:#E6A817;--bg:#0F1117;--bg2:#1A1D27;--bg3:#252833;--card:#1E2130;--card2:#252839;--txt:#E8E8E8;--txt2:#B0B0B0;--txt3:#787878;--brd:#333648;--shd:0 2px 12px rgba(0,0,0,.3);--shd2:0 4px 24px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden;font-size:15px}
h1,h2,h3,h4,h5{font-family:'Bricolage Grotesque',sans-serif;color:var(--txt);font-weight:700}
.topbar{background:var(--pri-d);color:#fff;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
html.dark .topbar{background:#161822;border-bottom:1px solid var(--brd)}
.topbar .logo{font-family:'Bricolage Grotesque',sans-serif;font-size:1.3rem;font-weight:800;display:flex;align-items:center;gap:8px}
.topbar .logo i{color:var(--acc);font-size:1.1rem}
.topbar .mode-tabs{display:flex;gap:4px;background:rgba(255,255,255,.1);border-radius:8px;padding:3px}
.topbar .mode-tab{padding:6px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;color:rgba(255,255,255,.7);transition:var(--trans);border:none;background:none}
.topbar .mode-tab.active{background:var(--acc);color:var(--pri-d)}
html.dark .topbar .mode-tab.active{color:#000}
.container{max-width:960px;margin:0 auto;padding:16px}
.section{display:none}
.section.active{display:block}
.page-title{font-size:1.6rem;margin-bottom:6px}
.page-sub{color:var(--txt3);margin-bottom:20px;font-size:.92rem}
.card{background:var(--card);border-radius:var(--rad2);padding:20px;box-shadow:var(--shd);border:1px solid var(--brd);margin-bottom:16px;transition:var(--trans)}
.card:hover{box-shadow:var(--shd2)}
.card-h{font-size:1.1rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.card-h i{color:var(--acc);font-size:1rem}
.nav-pills{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--brd)}
.pill{padding:7px 14px;border-radius:20px;cursor:pointer;font-size:.8rem;font-weight:600;color:var(--txt2);background:var(--bg2);border:1px solid var(--brd);transition:var(--trans)}
.pill.active{background:var(--pri);color:#fff;border-color:var(--pri)}
html.dark .pill.active{color:#000}
.form-group{margin-bottom:14px}
.form-group label{display:block;font-weight:600;font-size:.85rem;margin-bottom:5px;color:var(--txt2)}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 12px;border:1.5px solid var(--brd);border-radius:var(--rad);background:var(--card);color:var(--txt);font-size:16px;font-family:inherit;transition:var(--trans)}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--pri);box-shadow:0 0 0 3px rgba(27,67,50,.12)}
html.dark .form-group input:focus,html.dark .form-group select:focus,html.dark .form-group textarea:focus{box-shadow:0 0 0 3px rgba(74,222,128,.15)}
.form-group textarea{resize:vertical;min-height:80px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.btn{padding:10px 20px;border:none;border-radius:var(--rad);font-family:inherit;font-weight:600;font-size:.9rem;cursor:pointer;transition:var(--trans);display:inline-flex;align-items:center;gap:6px}
.btn-pri{background:var(--pri);color:#fff}
.btn-pri:hover{background:var(--pri-l)}
html.dark .btn-pri{color:#000}
.btn-acc{background:var(--acc);color:var(--pri-d)}
.btn-acc:hover{background:var(--acc-l)}
.btn-err{background:var(--err);color:#fff}
.btn-err:hover{opacity:.85}
.btn-out{background:transparent;border:1.5px solid var(--brd);color:var(--txt2)}
.btn-out:hover{border-color:var(--pri);color:var(--pri)}
.btn-wa{background:#25D366;color:#fff}
.btn-wa:hover{background:#1DA851}
.btn-sm{padding:6px 12px;font-size:.78rem}
.btn:disabled{opacity:.5;cursor:not-allowed}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:.72rem;font-weight:700}
.badge-suc{background:var(--suc-l);color:var(--suc)}
.badge-err{background:var(--err-l);color:var(--err)}
.badge-warn{background:var(--warn-l);color:var(--warn)}
.badge-pri{background:rgba(27,67,50,.1);color:var(--pri)}
html.dark .badge-pri{background:rgba(74,222,128,.15)}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--card);border-radius:var(--rad);padding:16px;text-align:center;border:1px solid var(--brd);box-shadow:var(--shd)}
.stat-card .num{font-family:'Bricolage Grotesque',sans-serif;font-size:1.8rem;font-weight:800;color:var(--pri)}
.stat-card .lbl{font-size:.78rem;color:var(--txt3);margin-top:2px}
.tbl-wrap{overflow-x:auto;border-radius:var(--rad);border:1px solid var(--brd)}
.tbl{width:100%;border-collapse:collapse;font-size:.82rem}
.tbl th{background:var(--bg2);font-weight:700;text-align:left;padding:10px 12px;color:var(--txt2);white-space:nowrap;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px}
.tbl td{padding:9px 12px;border-top:1px solid var(--brd);vertical-align:middle}
.tbl tr:hover td{background:var(--card2)}
.search-bar{position:relative;margin-bottom:14px}
.search-bar input{padding-left:36px}
.search-bar i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--txt3)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border-radius:var(--rad2);padding:24px;max-width:540px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:var(--shd2);animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-h{font-size:1.15rem;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.modal-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--txt3);padding:4px}
.toast-container{position:fixed;top:70px;right:16px;z-index:300;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 18px;border-radius:var(--rad);color:#fff;font-size:.85rem;font-weight:600;animation:toastIn .3s ease;box-shadow:var(--shd2);max-width:320px}
.toast-suc{background:var(--suc)}
.toast-err{background:var(--err)}
.toast-warn{background:var(--warn)}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.rules-box{max-height:300px;overflow-y:auto;background:var(--card2);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-bottom:14px;font-size:.85rem;line-height:1.7}
.rules-box h4{margin:12px 0 6px;color:var(--pri)}
.rules-box ol,.rules-box ul{padding-left:20px}
.check-row{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.check-row input[type=checkbox]{width:20px;height:20px;accent-color:var(--pri)}
.empty-state{text-align:center;padding:40px 20px;color:var(--txt3)}
.empty-state i{font-size:2.5rem;margin-bottom:10px;opacity:.4}
.empty-state p{font-size:.9rem}
.admin-login-wrap{display:flex;align-items:center;justify-content:center;min-height:60vh}
.admin-login-card{max-width:400px;width:100%;text-align:center}
.admin-login-card .lock-icon{width:70px;height:70px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:1.6rem;color:var(--pri)}
.pass-input{font-size:1rem;letter-spacing:2px;font-weight:600}
.lockout-bar{background:var(--err-l);color:var(--err);padding:10px 14px;border-radius:var(--rad);font-size:.82rem;font-weight:600;margin-bottom:12px;display:none}
.room-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
.room-cell{padding:16px 10px;border-radius:var(--rad);text-align:center;font-weight:700;font-size:.82rem;border:1.5px solid var(--brd);cursor:default;transition:var(--trans);position:relative}
.room-cell.full{background:var(--err-l);border-color:var(--err);color:var(--err)}
.room-cell.partial{background:var(--warn-l);border-color:var(--warn);color:var(--warn)}
.room-cell.empty{background:var(--suc-l);border-color:var(--suc);color:var(--suc)}
.room-cell .room-name{font-size:.95rem;margin-bottom:2px}
.room-cell .room-occ{font-size:.7rem;opacity:.8}
.notice-card{border-left:4px solid var(--acc)}
.notice-card .notice-date{font-size:.75rem;color:var(--txt3)}
.notice-card .notice-title{font-weight:700;margin:4px 0}
.tab-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.honeypot{position:absolute;left:-9999px;opacity:0;height:0}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .35s ease}
.settings-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--brd)}
.settings-row:last-child{border:none}
.settings-row label{flex:1;font-weight:600;font-size:.88rem}
.settings-row input{flex:2}
.export-section{margin-bottom:24px}
.export-section h4{margin-bottom:10px;font-size:.95rem}
.export-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px}
.gs-status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:.75rem;font-weight:700}
.gs-on{background:var(--suc-l);color:var(--suc)}
.gs-off{background:var(--err-l);color:var(--err)}
.strength-bar{height:4px;border-radius:2px;background:var(--bg3);margin-top:4px;overflow:hidden}
.strength-fill{height:100%;border-radius:2px;transition:width .3s ease,background .3s ease}
.gas-guide{background:var(--card2);border:1px solid var(--brd);border-radius:var(--rad);padding:16px;margin-top:14px;font-size:.82rem;line-height:1.8}
.gas-guide h5{margin-bottom:8px}
.gas-guide code{background:var(--bg3);padding:2px 6px;border-radius:4px;font-size:.78rem}
.gas-guide pre{background:var(--bg3);padding:12px;border-radius:var(--rad);overflow-x:auto;margin:8px 0;font-size:.72rem;line-height:1.5;white-space:pre-wrap}
</style>
</head>
<body>
<div class="topbar">
  <div class="logo"><i class="fas fa-building-user"></i> ResidentHub</div>
  <div class="mode-tabs">
    <button class="mode-tab active" onclick="switchMode('resident')">Resident</button>
    <button class="mode-tab" onclick="switchMode('admin')">Admin</button>
  </div>
</div>
<div class="toast-container" id="toasts"></div>

<!-- ===== RESIDENT PORTAL ===== -->
<div id="residentPortal" class="container section active">
  <nav class="nav-pills" id="resNavPills">
    <button class="pill active" data-tab="res-checkin"><i class="fas fa-right-to-bracket"></i> Check-In</button>
    <button class="pill" data-tab="res-rules"><i class="fas fa-scroll"></i> Rules</button>
    <button class="pill" data-tab="res-maintenance"><i class="fas fa-wrench"></i> Maintenance</button>
    <button class="pill" data-tab="res-incident"><i class="fas fa-triangle-exclamation"></i> Incident</button>
    <button class="pill" data-tab="res-checkout"><i class="fas fa-arrow-right-from-bracket"></i> Check-Out</button>
    <button class="pill" data-tab="res-notices"><i class="fas fa-bullhorn"></i> Notices</button>
  </nav>

  <!-- CHECK-IN -->
  <div id="res-checkin" class="res-tab active fade-in">
    <h2 class="page-title">Check-In Registration</h2>
    <p class="page-sub">Welcome! Complete the form below to register your arrival.</p>
    <div class="card">
      <form id="checkinForm" onsubmit="return handleCheckin(event)">
        <input type="text" name="hp_field" class="honeypot" tabindex="-1" autocomplete="off">
        <div class="form-row">
          <div class="form-group"><label>Full Name *</label><input type="text" id="ci_name" required></div>
          <div class="form-group"><label>Phone Number *</label><input type="tel" id="ci_phone" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Institution / University</label><input type="text" id="ci_institution"></div>
          <div class="form-group"><label>ID / Passport Number *</label><input type="text" id="ci_id" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Room *</label>
            <select id="ci_room" required><option value="">Select Room</option></select>
          </div>
          <div class="form-group"><label>Check-In Date *</label><input type="date" id="ci_date" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Resident Status</label>
            <select id="ci_status"><option value="New">New Resident</option><option value="Returning">Returning Resident</option></select>
          </div>
          <div class="form-group"><label>Deposit Status</label>
            <select id="ci_deposit"><option value="Paid">Paid</option><option value="Pending">Pending</option><option value="Partial">Partial</option></select>
          </div>
        </div>
        <div class="form-group"><label>Additional Notes</label><textarea id="ci_notes" rows="2" placeholder="Any special requirements or notes..."></textarea></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-check"></i> Submit Check-In</button>
      </form>
    </div>
  </div>

  <!-- RULES -->
  <div id="res-rules" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">House Rules &amp; Agreement</h2>
    <p class="page-sub">Please read the rules carefully and accept to proceed.</p>
    <div class="card">
      <div class="rules-box" id="rulesContent">
        <h4>1. General Conduct</h4>
        <ol>
          <li>All residents must treat each other, staff, and property with respect.</li>
          <li>Noise must be kept to acceptable levels, especially between 22:00 and 06:00.</li>
          <li>No illegal substances, weapons, or dangerous items are permitted on the premises.</li>
          <li>Visitors must be signed in and out at reception and are not permitted to stay overnight without prior approval.</li>
        </ol>
        <h4>2. Room &amp; Property Care</h4>
        <ol>
          <li>Residents are responsible for keeping their rooms clean and tidy.</li>
          <li>No alterations may be made to rooms (painting, drilling, etc.) without written permission.</li>
          <li>Any damage to property must be reported immediately and may result in charges.</li>
          <li>Room inspections may be conducted with 24 hours notice.</li>
        </ol>
        <h4>3. Safety &amp; Security</h4>
        <ol>
          <li>Doors must be locked when leaving. Lost keys must be reported immediately (replacement fee applies).</li>
          <li>Fire exits must remain clear at all times. Tampering with safety equipment is a serious offence.</li>
          <li>Report any suspicious activity or safety concerns to management immediately.</li>
        </ol>
        <h4>4. Payments &amp; Utilities</h4>
        <ol>
          <li>Rent is due on the 1st of each month. Late payments incur a penalty.</li>
          <li>Electricity and water are shared resources — excessive usage may be individually billed.</li>
          <li>Deposits are refundable upon satisfactory room inspection at check-out.</li>
        </ol>
        <h4>5. Check-Out Procedures</h4>
        <ol>
          <li>Written notice of departure must be given at least 14 days in advance.</li>
          <li>All keys must be returned. Room must be cleaned and cleared of personal belongings.</li>
          <li>A final inspection will be conducted before deposit refund processing.</li>
        </ol>
      </div>
      <form id="rulesForm" onsubmit="return handleRulesAccept(event)">
        <div class="form-row">
          <div class="form-group"><label>Your Full Name *</label><input type="text" id="ra_name" required></div>
          <div class="form-group"><label>Room *</label>
            <select id="ra_room" required><option value="">Select Room</option></select>
          </div>
        </div>
        <div class="check-row">
          <input type="checkbox" id="ra_accept" required>
          <label for="ra_accept" style="font-size:.88rem">I have read, understood, and agree to abide by all the house rules listed above. <strong>(Rules v1.0)</strong></label>
        </div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-file-signature"></i> Accept Rules</button>
      </form>
    </div>
  </div>

  <!-- MAINTENANCE -->
  <div id="res-maintenance" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Maintenance Request</h2>
    <p class="page-sub">Report an issue that needs fixing in your room or common areas.</p>
    <div class="card">
      <form id="maintenanceForm" onsubmit="return handleMaintenance(event)">
        <div class="form-row">
          <div class="form-group"><label>Your Name *</label><input type="text" id="mt_name" required></div>
          <div class="form-group"><label>Room *</label>
            <select id="mt_room" required><option value="">Select Room</option></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Category *</label>
            <select id="mt_category" required>
              <option value="">Select Category</option>
              <option>Plumbing</option><option>Electrical</option><option>Furniture</option>
              <option>Doors/Windows</option><option>Appliances</option><option>Pest Control</option>
              <option>Common Area</option><option>Other</option>
            </select>
          </div>
          <div class="form-group"><label>Urgency *</label>
            <select id="mt_urgency" required>
              <option value="Low">Low - Can wait</option>
              <option value="Medium">Medium - Needs attention soon</option>
              <option value="High">High - Urgent</option>
              <option value="Critical">Critical - Emergency</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Description *</label><textarea id="mt_desc" required placeholder="Describe the issue in detail..."></textarea></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-paper-plane"></i> Submit Request</button>
      </form>
    </div>
  </div>

  <!-- INCIDENT -->
  <div id="res-incident" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Incident Report</h2>
    <p class="page-sub">Report safety, hygiene, noise, theft, or conflict incidents. The admin will also be notified via WhatsApp.</p>
    <div class="card">
      <form id="incidentForm" onsubmit="return handleIncident(event)">
        <div class="form-row">
          <div class="form-group"><label>Your Name *</label><input type="text" id="in_name" required></div>
          <div class="form-group"><label>Room *</label>
            <select id="in_room" required><option value="">Select Room</option></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Incident Type *</label>
            <select id="in_type" required>
              <option value="">Select Type</option>
              <option>Safety</option><option>Hygiene</option><option>Noise</option>
              <option>Theft</option><option>Conflict</option><option>Property Damage</option><option>Other</option>
            </select>
          </div>
          <div class="form-group"><label>Urgency *</label>
            <select id="in_urgency" required>
              <option value="Low">Low</option><option value="Medium">Medium</option>
              <option value="High">High</option><option value="Critical">Critical</option>
            </select>
          </div>
        </div>
        <div class="form-group"><label>Description *</label><textarea id="in_desc" required placeholder="Describe the incident in detail..."></textarea></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-flag"></i> Submit &amp; Notify Admin</button>
      </form>
    </div>
  </div>

  <!-- CHECK-OUT -->
  <div id="res-checkout" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Check-Out Form</h2>
    <p class="page-sub">Complete this form when you are ready to vacate your room.</p>
    <div class="card">
      <form id="checkoutForm" onsubmit="return handleCheckout(event)">
        <div class="form-row">
          <div class="form-group"><label>Full Name *</label><input type="text" id="co_name" required></div>
          <div class="form-group"><label>Room *</label>
            <select id="co_room" required><option value="">Select Room</option></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Check-Out Date *</label><input type="date" id="co_date" required></div>
          <div class="form-group"><label>Key Returned? *</label>
            <select id="co_key" required><option value="Yes">Yes</option><option value="No">No</option></select>
          </div>
        </div>
        <div class="form-group"><label>Room Condition Notes</label><textarea id="co_condition" placeholder="Describe room condition..."></textarea></div>
        <div class="form-group"><label>Forwarding Contact (Phone/Email)</label><input type="text" id="co_forward"></div>
        <button type="submit" class="btn btn-pri"><i class="fas fa-door-open"></i> Submit Check-Out</button>
      </form>
    </div>
  </div>

  <!-- NOTICES -->
  <div id="res-notices" class="res-tab fade-in" style="display:none">
    <h2 class="page-title">Notices &amp; Announcements</h2>
    <p class="page-sub">Important updates from management.</p>
    <div id="resNoticesList"></div>
  </div>
</div>

<!-- ===== ADMIN PORTAL ===== -->
<div id="adminPortal" class="container section">
  <!-- Login -->
  <div id="adminLogin" class="admin-login-wrap">
    <div class="card admin-login-card">
      <div class="lock-icon"><i class="fas fa-shield-halved"></i></div>
      <h2 class="page-title" style="margin-bottom:6px">Admin Access</h2>
      <p class="page-sub">Enter the admin password to continue.</p>
      <div class="lockout-bar" id="lockoutBar"><i class="fas fa-lock"></i> <span id="lockoutMsg"></span></div>
      <form onsubmit="return handleAdminLogin(event)">
        <div class="form-group">
          <input type="password" id="adminPin" class="pass-input" maxlength="12" placeholder="Enter password..." required autocomplete="off">
          <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
        </div>
        <button type="submit" class="btn btn-pri" id="loginBtn" style="width:100%;justify-content:center"><i class="fas fa-sign-in-alt"></i> Unlock</button>
      </form>
      <p style="margin-top:12px;font-size:.72rem;color:var(--txt3)">Max 12 characters. Letters, numbers &amp; special characters allowed.<br>Default: Admin@2025!</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="adminDash" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:14px">
      <div>
        <h2 class="page-title">Admin Dashboard</h2>
        <p class="page-sub" style="margin:0">Manage residents, payments, and operations. <span class="gs-status" id="gsStatus"></span></p>
      </div>
      <button class="btn btn-out btn-sm" onclick="adminLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <nav class="nav-pills" id="adminNavPills">
      <button class="pill active" data-tab="adm-overview"><i class="fas fa-chart-pie"></i> Overview</button>
      <button class="pill" data-tab="adm-residents"><i class="fas fa-users"></i> Residents</button>
      <button class="pill" data-tab="adm-rooms"><i class="fas fa-door-closed"></i> Rooms</button>
      <button class="pill" data-tab="adm-payments"><i class="fas fa-money-bill"></i> Payments</button>
      <button class="pill" data-tab="adm-utilities"><i class="fas fa-bolt"></i> Utilities</button>
      <button class="pill" data-tab="adm-incidents"><i class="fas fa-flag"></i> Incidents</button>
      <button class="pill" data-tab="adm-notices"><i class="fas fa-bullhorn"></i> Notices</button>
      <button class="pill" data-tab="adm-exports"><i class="fas fa-download"></i> Exports</button>
      <button class="pill" data-tab="adm-settings"><i class="fas fa-cog"></i> Settings</button>
    </nav>

    <!-- OVERVIEW -->
    <div id="adm-overview" class="adm-tab active fade-in">
      <div class="stat-grid" id="statsGrid"></div>
      <div class="card"><div class="card-h"><i class="fas fa-clock"></i> Recent Activity</div><div id="activityLog"></div></div>
    </div>

    <!-- RESIDENTS -->
    <div id="adm-residents" class="adm-tab fade-in" style="display:none">
      <div class="tab-actions">
        <button class="btn btn-pri btn-sm" onclick="openModal('addResidentModal')"><i class="fas fa-plus"></i> Add Resident</button>
      </div>
      <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="residentSearch" placeholder="Search residents..." oninput="renderResidents()"></div>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Name</th><th>Room</th><th>Phone</th><th>Status</th><th>Payment</th><th>Actions</th></tr></thead><tbody id="residentsBody"></tbody></table></div>
    </div>

    <!-- ROOMS -->
    <div id="adm-rooms" class="adm-tab fade-in" style="display:none">
      <div class="card">
        <div class="card-h"><i class="fas fa-th-large"></i> Room Overview — 5 Rooms, 13 Beds Total</div>
        <div style="display:flex;gap:16px;margin-bottom:14px;font-size:.8rem;flex-wrap:wrap">
          <span><span style="display:inline-block;width:12px;height:12px;background:var(--suc-l);border:1px solid var(--suc);border-radius:3px"></span> Empty</span>
          <span><span style="display:inline-block;width:12px;height:12px;background:var(--warn-l);border:1px solid var(--warn);border-radius:3px"></span> Partially Occupied</span>
          <span><span style="display:inline-block;width:12px;height:12px;background:var(--err-l);border:1px solid var(--err);border-radius:3px"></span> Full</span>
        </div>
        <div class="room-grid" id="roomGrid"></div>
      </div>
      <div class="card" id="roomDetailCard" style="display:none">
        <div class="card-h"><i class="fas fa-bed"></i> <span id="roomDetailTitle">Room Detail</span></div>
        <div id="roomDetailBody"></div>
      </div>
    </div>

    <!-- PAYMENTS -->
    <div id="adm-payments" class="adm-tab fade-in" style="display:none">
      <div class="tab-actions">
        <button class="btn btn-pri btn-sm" onclick="openModal('addPaymentModal')"><i class="fas fa-plus"></i> Record Payment</button>
      </div>
      <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="paymentSearch" placeholder="Search payments..." oninput="renderPayments()"></div>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>Resident</th><th>Month</th><th>Amount</th><th>Balance</th><th>Method</th><th>Ref</th></tr></thead><tbody id="paymentsBody"></tbody></table></div>
    </div>

    <!-- UTILITIES -->
    <div id="adm-utilities" class="adm-tab fade-in" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button class="btn btn-out btn-sm util-tab active" data-util="power" onclick="switchUtilTab('power')"><i class="fas fa-bolt"></i> Electricity</button>
        <button class="btn btn-out btn-sm util-tab" data-util="water" onclick="switchUtilTab('water')"><i class="fas fa-droplet"></i> Water</button>
      </div>
      <div id="util-power">
        <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addPowerModal')"><i class="fas fa-plus"></i> Add Recharge</button></div>
        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>Units</th><th>Amount (USD)</th><th>Balance After</th><th>Notes</th></tr></thead><tbody id="powerBody"></tbody></table></div>
      </div>
      <div id="util-water" style="display:none">
        <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addWaterModal')"><i class="fas fa-plus"></i> Add Delivery</button></div>
        <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>Litres</th><th>Supplier</th><th>Cost</th><th>Tank Filled</th><th>Notes</th></tr></thead><tbody id="waterBody"></tbody></table></div>
      </div>
    </div>

    <!-- INCIDENTS -->
    <div id="adm-incidents" class="adm-tab fade-in" style="display:none">
      <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="incidentSearch" placeholder="Search incidents..." oninput="renderIncidents()"></div>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>Date</th><th>By</th><th>Room</th><th>Type</th><th>Urgency</th><th>Status</th><th>Actions</th></tr></thead><tbody id="incidentsBody"></tbody></table></div>
    </div>

    <!-- NOTICES -->
    <div id="adm-notices" class="adm-tab fade-in" style="display:none">
      <div class="tab-actions"><button class="btn btn-pri btn-sm" onclick="openModal('addNoticeModal')"><i class="fas fa-plus"></i> Post Notice</button></div>
      <div id="adminNoticesList"></div>
    </div>

    <!-- EXPORTS -->
    <div id="adm-exports" class="adm-tab fade-in" style="display:none">
      <div class="export-section">
        <h3 style="margin-bottom:4px">Export Reports</h3>
        <p class="page-sub">Download individual datasets or a combined full report. Choose CSV or PDF format.</p>
      </div>
      <div class="card">
        <div class="card-h"><i class="fas fa-file-lines"></i> Individual Reports</div>
        <div class="export-grid">
          <button class="btn btn-out" onclick="doExport('residents','csv')"><i class="fas fa-file-csv"></i> Residents CSV</button>
          <button class="btn btn-out" onclick="doExport('residents','pdf')"><i class="fas fa-file-pdf"></i> Residents PDF</button>
          <button class="btn btn-out" onclick="doExport('payments','csv')"><i class="fas fa-file-csv"></i> Payments CSV</button>
          <button class="btn btn-out" onclick="doExport('payments','pdf')"><i class="fas fa-file-pdf"></i> Payments PDF</button>
          <button class="btn btn-out" onclick="doExport('incidents','csv')"><i class="fas fa-file-csv"></i> Incidents CSV</button>
          <button class="btn btn-out" onclick="doExport('incidents','pdf')"><i class="fas fa-file-pdf"></i> Incidents PDF</button>
          <button class="btn btn-out" onclick="doExport('checkins','csv')"><i class="fas fa-file-csv"></i> Check-Ins CSV</button>
          <button class="btn btn-out" onclick="doExport('checkins','pdf')"><i class="fas fa-file-pdf"></i> Check-Ins PDF</button>
          <button class="btn btn-out" onclick="doExport('checkouts','csv')"><i class="fas fa-file-csv"></i> Check-Outs CSV</button>
          <button class="btn btn-out" onclick="doExport('checkouts','pdf')"><i class="fas fa-file-pdf"></i> Check-Outs PDF</button>
          <button class="btn btn-out" onclick="doExport('maintenance','csv')"><i class="fas fa-file-csv"></i> Maintenance CSV</button>
          <button class="btn btn-out" onclick="doExport('maintenance','pdf')"><i class="fas fa-file-pdf"></i> Maintenance PDF</button>
          <button class="btn btn-out" onclick="doExport('power','csv')"><i class="fas fa-file-csv"></i> Electricity CSV</button>
          <button class="btn btn-out" onclick="doExport('power','pdf')"><i class="fas fa-file-pdf"></i> Electricity PDF</button>
          <button class="btn btn-out" onclick="doExport('water','csv')"><i class="fas fa-file-csv"></i> Water CSV</button>
          <button class="btn btn-out" onclick="doExport('water','pdf')"><i class="fas fa-file-pdf"></i> Water PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="card-h"><i class="fas fa-layer-group"></i> Combined Full Report</div>
        <p style="font-size:.85rem;color:var(--txt2);margin-bottom:12px">Export ALL data across every category into a single file.</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-pri" onclick="doExport('combined','csv')"><i class="fas fa-file-csv"></i> Combined CSV</button>
          <button class="btn btn-acc" onclick="doExport('combined','pdf')"><i class="fas fa-file-pdf"></i> Combined PDF</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="adm-settings" class="adm-tab fade-in" style="display:none">
      <div class="card">
        <div class="card-h"><i class="fas fa-shield-halved"></i> Security Settings</div>
        <div class="settings-row">
          <label>Admin Password (max 12 chars)</label>
          <input type="password" id="settingPin" maxlength="12">
          <button class="btn btn-sm btn-pri" onclick="updatePin()">Update</button>
        </div>
        <p style="font-size:.75rem;color:var(--txt3);margin-top:4px">Use letters, numbers &amp; special characters (!@#$%^&amp;*) for a strong password.</p>
      </div>
      <div class="card">
        <div class="card-h"><i class="fas fa-link"></i> Google Sheets Integration</div>
        <div class="settings-row">
          <label>Apps Script Web App URL</label>
          <input type="url" id="settingGAS" placeholder="https://script.google.com/macros/s/.../exec">
          <button class="btn btn-sm btn-pri" onclick="updateGAS()">Save</button>
        </div>
        <div class="settings-row">
          <label>Sync Secret Key</label>
          <input type="text" id="settingSecret" placeholder="your-secret-key">
          <button class="btn btn-sm btn-pri" onclick="updateSecret()">Save</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm btn-pri" onclick="testGASConnection()"><i class="fas fa-wifi"></i> Test Connection</button>
          <button class="btn btn-sm btn-acc" onclick="syncAllToSheet()"><i class="fas fa-cloud-arrow-up"></i> Push All Data</button>
          <button class="btn btn-sm btn-out" onclick="pullFromSheet()"><i class="fas fa-cloud-arrow-down"></i> Pull Data</button>
        </div>
        <div class="gas-guide">
          <h5><i class="fas fa-book"></i> Google Sheets Setup Guide</h5>
          <p><strong>Step 1:</strong> Create a new Google Sheet. Add these tabs (sheet names):</p>
          <p><code>Residents</code> <code>CheckIns</code> <code>CheckOuts</code> <code>RulesAcceptance</code> <code>Payments</code> <code>Incidents</code> <code>Maintenance</code> <code>Power</code> <code>Water</code> <code>Notices</code></p>
          <p><strong>Step 2:</strong> Go to <strong>Extensions → Apps Script</strong>. Delete the default code and paste the script below. Change <code>YOUR_SECRET_KEY</code> to a strong secret.</p>
          <pre>const SECRET = "YOUR_SECRET_KEY";
const SS = SpreadsheetApp.getActiveSpreadsheet();

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    if (data.secret !== SECRET)
      return resp({ error: "Unauthorized" });
    const action = data.action;
    if (action === "append") {
      const sheet = SS.getSheetByName(data.sheet);
      if (!sheet) return resp({ error: "Sheet not found: " + data.sheet });
      data.rows.forEach(function(r) { sheet.appendRow(r); });
      return resp({ ok: true, appended: data.rows.length });
    }
    if (action === "replace") {
      const sheet = SS.getSheetByName(data.sheet);
      if (!sheet) return resp({ error: "Sheet not found: " + data.sheet });
      sheet.clearContents();
      if (data.headers) sheet.appendRow(data.headers);
      data.rows.forEach(function(r) { sheet.appendRow(r); });
      return resp({ ok: true, replaced: data.rows.length });
    }
    if (action === "pushAll") {
      var results = {};
      Object.keys(data.tables).forEach(function(name) {
        var sheet = SS.getSheetByName(name);
        if (!sheet) { results[name] = "not found"; return; }
        sheet.clearContents();
        var tbl = data.tables[name];
        if (tbl.headers) sheet.appendRow(tbl.headers);
        tbl.rows.forEach(function(r) { sheet.appendRow(r); });
        results[name] = tbl.rows.length + " rows";
      });
      return resp({ ok: true, results: results });
    }
    if (action === "pullAll") {
      var tables = {};
      var names = ["Residents","CheckIns","CheckOuts",
        "RulesAcceptance","Payments","Incidents",
        "Maintenance","Power","Water","Notices"];
      names.forEach(function(name) {
        var sheet = SS.getSheetByName(name);
        if (!sheet) return;
        var vals = sheet.getDataRange().getValues();
        tables[name] = vals;
      });
      return resp({ ok: true, tables: tables });
    }
    if (action === "ping") return resp({ ok: true, msg: "connected" });
    return resp({ error: "Unknown action" });
  } catch (err) {
    return resp({ error: err.message });
  }
}

function doGet(e) {
  return resp({ ok: true, msg: "ResidentHub API" });
}

function resp(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
          <p><strong>Step 3:</strong> Click <strong>Deploy → New deployment</strong>. Select <strong>Web app</strong>. Set "Execute as" to <strong>Me</strong> and "Who has access" to <strong>Anyone</strong>. Deploy and copy the URL.</p>
          <p><strong>Step 4:</strong> Paste the URL above and enter the same secret key. Click <strong>Test Connection</strong>.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALS ===== -->
<div class="modal-overlay" id="addResidentModal">
  <div class="modal">
    <div class="modal-h"><span><i class="fas fa-user-plus"></i> Add Resident</span><button class="modal-close" onclick="closeModal('addResidentModal')">&times;</button></div>
    <form onsubmit="return addResidentManual(event)">
      <div class="form-row">
        <div class="form-group"><label>Full Name *</label><input type="text" id="ar_name" required></div>
        <div class="form-group"><label>Phone *</label><input type="tel" id="ar_phone" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Institution</label><input type="text" id="ar_inst"></div>
        <div class="form-group"><label>ID Number *</label><input type="text" id="ar_id" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Room *</label><select id="ar_room" required><option value="">Select</option></select></div>
        <div class="form-group"><label>Status</label><select id="ar_status"><option>New</option><option>Returning</option></select></div>
      </div>
      <button type="submit" class="btn btn-pri" style="width:100%;justify-content:center"><i class="fas fa-save"></i> Save Resident</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="addPaymentModal">
  <div class="modal">
    <div class="modal-h"><span><i class="fas fa-money-bill"></i> Record Payment</span><button class="modal-close" onclick="closeModal('addPaymentModal')">&times;</button></div>
    <form onsubmit="return addPayment(event)">
      <div class="form-row">
        <div class="form-group"><label>Resident Name *</label><input type="text" id="pm_name" required></div>
        <div class="form-group"><label>Month *</label><input type="month" id="pm_month" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Amount Paid *</label><input type="number" id="pm_amount" step="0.01" required></div>
        <div class="form-group"><label>Outstanding Balance</label><input type="number" id="pm_balance" step="0.01" value="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Method *</label>
          <select id="pm_method" required><option>Cash</option><option>EcoCash</option><option>Bank Transfer</option><option>Other</option></select>
        </div>
        <div class="form-group"><label>Reference</label><input type="text" id="pm_ref"></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="pm_notes" rows="2"></textarea></div>
      <button type="submit" class="btn btn-pri" style="width:100%;justify-content:center"><i class="fas fa-save"></i> Save Payment</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="addPowerModal">
  <div class="modal">
    <div class="modal-h"><span><i class="fas fa-bolt"></i> Electricity Recharge</span><button class="modal-close" onclick="closeModal('addPowerModal')">&times;</button></div>
    <form onsubmit="return addPower(event)">
      <div class="form-row">
        <div class="form-group"><label>Date *</label><input type="date" id="pw_date" required></div>
        <div class="form-group"><label>Units Bought *</label><input type="number" id="pw_units" step="0.1" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Amount (USD) *</label><input type="number" id="pw_amount" step="0.01" required></div>
        <div class="form-group"><label>Balance Units After</label><input type="number" id="pw_balance" step="0.1"></div>
      </div>
      <div class="form-group"><label>Notes</label><textarea id="pw_notes" rows="2"></textarea></div>
      <button type="submit" class="btn btn-pri" style="width:100%;justify-content:center"><i class="fas fa-save"></i> Save</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="addWaterModal">
  <div class="modal">
    <div class="modal-h"><span><i class="fas fa-droplet"></i> Water Delivery</span><button class="modal-close" onclick="closeModal('addWaterModal')">&times;</button></div>
    <form onsubmit="return addWater(event)">
      <div class="form-row">
        <div class="form-group"><label>Date *</label><input type="date" id="wt_date" required></div>
        <div class="form-group"><label>Litres *</label><input type="number" id="wt_litres" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Supplier</label><input type="text" id="wt_supplier"></div>
        <div class="form-group"><label>Cost (USD) *</label><input type="number" id="wt_cost" step="0.01" required></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Tank Filled?</label><select id="wt_filled"><option>Yes</option><option>No</option></select></div>
        <div class="form-group"><label>Notes</label><input type="text" id="wt_notes"></div>
      </div>
      <button type="submit" class="btn btn-pri" style="width:100%;justify-content:center"><i class="fas fa-save"></i> Save</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="addNoticeModal">
  <div class="modal">
    <div class="modal-h"><span><i class="fas fa-bullhorn"></i> Post Notice</span><button class="modal-close" onclick="closeModal('addNoticeModal')">&times;</button></div>
    <form onsubmit="return addNotice(event)">
      <div class="form-group"><label>Title *</label><input type="text" id="nt_title" required></div>
      <div class="form-group"><label>Content *</label><textarea id="nt_content" rows="4" required></textarea></div>
      <div class="form-group"><label>Priority</label>
        <select id="nt_priority"><option value="Normal">Normal</option><option value="Important">Important</option><option value="Urgent">Urgent</option></select>
      </div>
      <button type="submit" class="btn btn-pri" style="width:100%;justify-content:center"><i class="fas fa-paper-plane"></i> Publish</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:400px;text-align:center">
    <div class="modal-h"><span id="confirmTitle">Confirm</span><button class="modal-close" onclick="closeModal('confirmModal')">&times;</button></div>
    <p id="confirmMsg" style="margin-bottom:18px;color:var(--txt2)"></p>
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="btn btn-out" onclick="closeModal('confirmModal')">Cancel</button>
      <button class="btn btn-err" id="confirmBtn">Confirm</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="viewIncidentModal">
  <div class="modal">
    <div class="modal-h"><span><i class="fas fa-flag"></i> Incident Details</span><button class="modal-close" onclick="closeModal('viewIncidentModal')">&times;</button></div>
    <div id="incidentDetail"></div>
  </div>
</div>

<script>
/* ===== DARK MODE ===== */
if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){document.documentElement.classList.add('dark')}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(e){e.matches?document.documentElement.classList.add('dark'):document.documentElement.classList.remove('dark')});

/* ===== ROOM DEFINITIONS ===== */
var ROOMS = [
  { id: 'blue-white', name: 'Blue-White', capacity: 3 },
  { id: 'black-gold', name: 'Black-Gold', capacity: 3 },
  { id: 'ensuite', name: 'Ensuite', capacity: 3 },
  { id: 'crystal-1', name: 'Crystal 1', capacity: 2 },
  { id: 'crystal-2', name: 'Crystal 2', capacity: 2 }
];
var TOTAL_CAPACITY = 13;
var ADMIN_PHONE = '263771308790';

/* ===== DATA STORE ===== */
var DB = {
  config: { pin: 'Admin@2025!', gasUrl: '', gasSecret: '' },
  residents: [],
  checkins: [],
  checkouts: [],
  rulesAcceptance: [],
  payments: [],
  incidents: [],
  maintenance: [],
  power: [],
  water: [],
  notices: [
    { id: 'n1', title: 'Welcome to Semester 1, 2025', content: 'We are excited to welcome all residents for the new semester. Please ensure you complete your check-in process and rules acceptance within 48 hours of arrival.', priority: 'Important', createdAt: '2025-01-15T08:00:00' },
    { id: 'n2', title: 'Water Schedule Update', content: 'Water deliveries have been moved to Tuesdays and Fridays. Please plan your usage accordingly. Report any leaks immediately.', priority: 'Normal', createdAt: '2025-01-20T10:30:00' }
  ],
  activity: []
};
var idCounters = { resident:100, payment:200, incident:300, maintenance:400, power:500, water:600, notice:700, checkin:800, checkout:900, rules:1000 };
function nextId(type) { return type.charAt(0).toUpperCase() + (++idCounters[type]); }
function now() { return new Date().toISOString(); }
function fmtDate(iso) { if(!iso) return '-'; var d = new Date(iso); return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
function fmtDateTime(iso) { if(!iso) return '-'; var d = new Date(iso); return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function addActivity(msg) { DB.activity.unshift({msg:msg,time:now()}); if(DB.activity.length>50) DB.activity.pop(); }

/* ===== TOAST ===== */
function toast(msg,type) {
  var t = document.createElement('div');
  t.className = 'toast toast-'+(type||'suc');
  t.textContent = msg;
  document.getElementById('toasts').appendChild(t);
  setTimeout(function(){ t.remove(); },3500);
}

/* ===== MODAL ===== */
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function showConfirm(title,msg,onConfirm) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  var btn = document.getElementById('confirmBtn');
  var newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  newBtn.id = 'confirmBtn';
  newBtn.addEventListener('click', function(){ closeModal('confirmModal'); onConfirm(); });
  openModal('confirmModal');
}

/* ===== NAVIGATION ===== */
function switchMode(mode) {
  document.querySelectorAll('.mode-tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.section').forEach(function(s){ s.classList.remove('active'); });
  if(mode==='resident') {
    document.querySelector('.mode-tab:nth-child(1)').classList.add('active');
    document.getElementById('residentPortal').classList.add('active');
  } else {
    document.querySelector('.mode-tab:nth-child(2)').classList.add('active');
    document.getElementById('adminPortal').classList.add('active');
  }
}

function setupTabs(navId, tabClass) {
  document.getElementById(navId).addEventListener('click', function(e){
    var pill = e.target.closest('.pill');
    if(!pill) return;
    document.querySelectorAll('#'+navId+' .pill').forEach(function(p){p.classList.remove('active');});
    pill.classList.add('active');
    document.querySelectorAll('.'+tabClass).forEach(function(t){t.style.display='none';});
    var target = document.getElementById(pill.dataset.tab);
    if(target){target.style.display='block';target.classList.remove('active');void target.offsetWidth;target.classList.add('active');}
    if(tabClass==='adm-tab') refreshAdminTab(pill.dataset.tab);
  });
}
setupTabs('resNavPills','res-tab');

/* ===== ROOM HELPERS ===== */
function getRoomOptions() {
  var html = '<option value="">Select Room</option>';
  ROOMS.forEach(function(r){ html += '<option value="'+r.id+'">'+r.name+' ('+r.capacity+' beds)</option>'; });
  return html;
}
function populateRoomSelects() {
  var html = getRoomOptions();
  ['ci_room','ra_room','mt_room','in_room','co_room','ar_room'].forEach(function(id){
    var el = document.getElementById(id);
    if(el) el.innerHTML = html;
  });
}
populateRoomSelects();

function getRoomName(id) {
  var r = ROOMS.find(function(x){return x.id===id;});
  return r ? r.name : id;
}
function getRoomOccupants(roomId) {
  return DB.residents.filter(function(r){return r.room===roomId;});
}
function isRoomFull(roomId) {
  var rm = ROOMS.find(function(x){return x.id===roomId;});
  if(!rm) return true;
  return getRoomOccupants(roomId).length >= rm.capacity;
}

/* ===== GOOGLE SHEETS API ===== */
function gasCall(payload) {
  if(!DB.config.gasUrl) return Promise.reject(new Error('No GAS URL configured'));
  payload.secret = DB.config.gasSecret;
  return fetch(DB.config.gasUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify(payload)
  }).then(function(r){ return r.json(); });
}

function syncToSheet(sheetName, headers, rows) {
  if(!DB.config.gasUrl) return;
  gasCall({ action:'replace', sheet:sheetName, headers:headers, rows:rows })
    .then(function(r){ if(r.error) console.log('Sync error ('+sheetName+'): '+r.error); })
    .catch(function(){});
}

function autoSync(sheetName, headers, dataArray, mapper) {
  if(!DB.config.gasUrl) return;
  var rows = dataArray.map(mapper);
  syncToSheet(sheetName, headers, rows);
}

function syncResidents() {
  autoSync('Residents',
    ['ID','Name','Phone','Institution','IDNumber','Room','Status','CheckInDate','PaymentStatus','Notes','CreatedAt'],
    DB.residents, function(r){ return [r.id,r.name,r.phone,r.institution,r.idNumber,getRoomName(r.room),r.status,r.checkinDate,r.paymentStatus,r.notes,r.createdAt]; });
}
function syncCheckins() {
  autoSync('CheckIns',
    ['ID','Name','Phone','Institution','IDNumber','Room','Date','Status','Deposit','Notes','CreatedAt'],
    DB.checkins, function(c){ return [c.id,c.name,c.phone,c.institution,c.idNumber,getRoomName(c.room),c.date,c.status,c.deposit,c.notes,c.createdAt]; });
}
function syncCheckouts() {
  autoSync('CheckOuts',
    ['ID','Name','Room','Date','KeyReturned','Condition','ForwardContact','CreatedAt'],
    DB.checkouts, function(c){ return [c.id,c.name,getRoomName(c.room),c.date,c.keyReturned,c.condition,c.forwardContact,c.createdAt]; });
}
function syncRules() {
  autoSync('RulesAcceptance',
    ['ID','Name','Room','Accepted','AcceptedAt','Version'],
    DB.rulesAcceptance, function(r){ return [r.id,r.name,getRoomName(r.room),r.accepted,r.acceptedAt,r.version]; });
}
function syncPayments() {
  autoSync('Payments',
    ['ID','Name','Month','Amount','Balance','Method','Reference','Notes','PaidDate','RecordedBy'],
    DB.payments, function(p){ return [p.id,p.name,p.month,p.amount,p.balance,p.method,p.ref,p.notes,p.paidDate,p.recordedBy]; });
}
function syncIncidents() {
  autoSync('Incidents',
    ['ID','SubmittedBy','Room','Type','Urgency','Description','Status','AdminNotes','CreatedAt','ClosedAt'],
    DB.incidents, function(i){ return [i.id,i.submittedBy,getRoomName(i.room),i.type,i.urgency,i.description,i.status,i.adminNotes,i.createdAt,i.closedAt]; });
}
function syncMaintenance() {
  autoSync('Maintenance',
    ['ID','Name','Room','Category','Urgency','Description','Status','CreatedAt'],
    DB.maintenance, function(m){ return [m.id,m.name,getRoomName(m.room),m.category,m.urgency,m.description,m.status,m.createdAt]; });
}
function syncPower() {
  autoSync('Power',['ID','Date','Units','Amount','Balance','Notes'],DB.power,function(p){return[p.id,p.date,p.units,p.amount,p.balance,p.notes];});
}
function syncWater() {
  autoSync('Water',['ID','Date','Litres','Supplier','Cost','Filled','Notes'],DB.water,function(w){return[w.id,w.date,w.litres,w.supplier,w.cost,w.filled,w.notes];});
}
function syncNotices() {
  autoSync('Notices',['ID','Title','Content','Priority','CreatedAt'],DB.notices,function(n){return[n.id,n.title,n.content,n.priority,n.createdAt];});
}

function testGASConnection() {
  if(!DB.config.gasUrl){ toast('Enter a GAS URL first','warn'); return; }
  toast('Testing connection...','warn');
  gasCall({action:'ping'}).then(function(r){
    if(r.ok) { toast('Connected to Google Sheets!'); updateGSStatus(true); }
    else toast('Error: '+(r.error||'Unknown'),'err');
  }).catch(function(e){ toast('Connection failed: '+e.message,'err'); });
}

function syncAllToSheet() {
  if(!DB.config.gasUrl){ toast('Configure GAS URL first','warn'); return; }
  toast('Pushing all data...','warn');
  var tables = {};
  tables.Residents = { headers:['ID','Name','Phone','Institution','IDNumber','Room','Status','CheckInDate','PaymentStatus','Notes','CreatedAt'], rows: DB.residents.map(function(r){return[r.id,r.name,r.phone,r.institution,r.idNumber,getRoomName(r.room),r.status,r.checkinDate,r.paymentStatus,r.notes,r.createdAt];}) };
  tables.CheckIns = { headers:['ID','Name','Phone','Institution','IDNumber','Room','Date','Status','Deposit','Notes','CreatedAt'], rows: DB.checkins.map(function(c){return[c.id,c.name,c.phone,c.institution,c.idNumber,getRoomName(c.room),c.date,c.status,c.deposit,c.notes,c.createdAt];}) };
  tables.CheckOuts = { headers:['ID','Name','Room','Date','KeyReturned','Condition','ForwardContact','CreatedAt'], rows: DB.checkouts.map(function(c){return[c.id,c.name,getRoomName(c.room),c.date,c.keyReturned,c.condition,c.forwardContact,c.createdAt];}) };
  tables.RulesAcceptance = { headers:['ID','Name','Room','Accepted','AcceptedAt','Version'], rows: DB.rulesAcceptance.map(function(r){return[r.id,r.name,getRoomName(r.room),r.accepted,r.acceptedAt,r.version];}) };
  tables.Payments = { headers:['ID','Name','Month','Amount','Balance','Method','Reference','Notes','PaidDate','RecordedBy'], rows: DB.payments.map(function(p){return[p.id,p.name,p.month,p.amount,p.balance,p.method,p.ref,p.notes,p.paidDate,p.recordedBy];}) };
  tables.Incidents = { headers:['ID','SubmittedBy','Room','Type','Urgency','Description','Status','AdminNotes','CreatedAt','ClosedAt'], rows: DB.incidents.map(function(i){return[i.id,i.submittedBy,getRoomName(i.room),i.type,i.urgency,i.description,i.status,i.adminNotes,i.createdAt,i.closedAt];}) };
  tables.Maintenance = { headers:['ID','Name','Room','Category','Urgency','Description','Status','CreatedAt'], rows: DB.maintenance.map(function(m){return[m.id,m.name,getRoomName(m.room),m.category,m.urgency,m.description,m.status,m.createdAt];}) };
  tables.Power = { headers:['ID','Date','Units','Amount','Balance','Notes'], rows: DB.power.map(function(p){return[p.id,p.date,p.units,p.amount,p.balance,p.notes];}) };
  tables.Water = { headers:['ID','Date','Litres','Supplier','Cost','Filled','Notes'], rows: DB.water.map(function(w){return[w.id,w.date,w.litres,w.supplier,w.cost,w.filled,w.notes];}) };
  tables.Notices = { headers:['ID','Title','Content','Priority','CreatedAt'], rows: DB.notices.map(function(n){return[n.id,n.title,n.content,n.priority,n.createdAt];}) };
  gasCall({action:'pushAll',tables:tables}).then(function(r){
    if(r.ok) toast('All data pushed to Google Sheets!');
    else toast('Error: '+(r.error||'Unknown'),'err');
  }).catch(function(e){ toast('Push failed: '+e.message,'err'); });
}

function pullFromSheet() {
  if(!DB.config.gasUrl){ toast('Configure GAS URL first','warn'); return; }
  toast('Pulling data from Sheets...','warn');
  gasCall({action:'pullAll'}).then(function(r){
    if(!r.ok){ toast('Error: '+(r.error||'Unknown'),'err'); return; }
    toast('Data pulled! Check console for raw data.','suc');
    console.log(JSON.stringify(r.tables));
  }).catch(function(e){ toast('Pull failed: '+e.message,'err'); });
}

function updateGSStatus(connected) {
  var el = document.getElementById('gsStatus');
  if(DB.config.gasUrl) {
    el.className = 'gs-status '+(connected?'gs-on':'gs-off');
    el.innerHTML = '<i class="fas fa-'+(connected?'cloud':'cloud-xmark')+'"></i> '+(connected?'Sheets Connected':'Sheets Configured');
  } else { el.className='gs-status gs-off'; el.innerHTML='<i class="fas fa-cloud-xmark"></i> Offline Mode'; }
}

/* ===== WHATSAPP INCIDENT NOTIFICATION ===== */
function sendWhatsAppIncident(data) {
  var msg = '🚨 *INCIDENT REPORT*\n\n';
  msg += '👤 *Reported by:* '+data.submittedBy+'\n';
  msg += '🏠 *Room:* '+getRoomName(data.room)+'\n';
  msg += '⚠️ *Type:* '+data.type+'\n';
  msg += '🔴 *Urgency:* '+data.urgency+'\n';
  msg += '📝 *Description:*\n'+data.description+'\n\n';
  msg += '📅 '+fmtDateTime(data.createdAt);
  var encoded = encodeURIComponent(msg);
  var url = 'https://wa.me/'+ADMIN_PHONE+'?text='+encoded;
  window.open(url,'_blank');
}

/* ===== ADMIN SECURITY ===== */
var loginAttempts = 0;
var lockoutUntil = 0;
var MAX_ATTEMPTS = 5;
var LOCKOUT_SECONDS = 60;
var lockoutTimer = null;

function handleAdminLogin(e) {
  e.preventDefault();
  var nowMs = Date.now();
  if(nowMs < lockoutUntil) {
    var secs = Math.ceil((lockoutUntil-nowMs)/1000);
    showLockout(secs);
    return false;
  }
  var val = document.getElementById('adminPin').value;
  if(val === DB.config.pin) {
    loginAttempts = 0;
    hideLockout();
    document.getElementById('adminLogin').style.display='none';
    document.getElementById('adminDash').style.display='block';
    setupTabs('adminNavPills','adm-tab');
    refreshAdminTab('adm-overview');
    updateGSStatus(false);
    toast('Welcome, Admin!');
    addActivity('Admin logged in');
  } else {
    loginAttempts++;
    var remaining = MAX_ATTEMPTS - loginAttempts;
    if(remaining <= 0) {
      lockoutUntil = nowMs + (LOCKOUT_SECONDS*1000);
      loginAttempts = 0;
      showLockout(LOCKOUT_SECONDS);
      startLockoutCountdown();
      toast('Too many failed attempts. Locked out for '+LOCKOUT_SECONDS+'s','err');
    } else {
      toast('Incorrect password. '+remaining+' attempt'+(remaining===1?'':'s')+' remaining.','err');
    }
  }
  document.getElementById('adminPin').value='';
  updateStrength('');
  return false;
}

function showLockout(secs) {
  var bar = document.getElementById('lockoutBar');
  bar.style.display='block';
  document.getElementById('lockoutMsg').textContent = 'Account locked. Try again in '+secs+' seconds.';
  document.getElementById('loginBtn').disabled = true;
}
function hideLockout() {
  document.getElementById('lockoutBar').style.display='none';
  document.getElementById('loginBtn').disabled = false;
  if(lockoutTimer) { clearInterval(lockoutTimer); lockoutTimer=null; }
}
function startLockoutCountdown() {
  if(lockoutTimer) clearInterval(lockoutTimer);
  lockoutTimer = setInterval(function(){
    var remaining = Math.ceil((lockoutUntil-Date.now())/1000);
    if(remaining<=0) { hideLockout(); }
    else { document.getElementById('lockoutMsg').textContent='Account locked. Try again in '+remaining+' seconds.'; }
  },1000);
}

function adminLogout() {
  document.getElementById('adminLogin').style.display='';
  document.getElementById('adminDash').style.display='none';
  toast('Logged out');
  addActivity('Admin logged out');
}

/* Password strength indicator */
document.getElementById('adminPin').addEventListener('input',function(){
  updateStrength(this.value);
});
function updateStrength(val) {
  var fill = document.getElementById('strengthFill');
  if(!val) { fill.style.width='0%'; return; }
  var score = 0;
  if(val.length>=4) score++;
  if(val.length>=8) score++;
  if(/[A-Z]/.test(val)) score++;
  if(/[0-9]/.test(val)) score++;
  if(/[^A-Za-z0-9]/.test(val)) score++;
  var pct = Math.min(100, score*20);
  fill.style.width = pct+'%';
  fill.style.background = pct<=40?'var(--err)':pct<=60?'var(--warn)':'var(--suc)';
}

/* ===== RESIDENT FORMS ===== */
function handleCheckin(e) {
  e.preventDefault();
  var hp = e.target.querySelector('.honeypot');
  if(hp && hp.value) return false;
  var roomId = document.getElementById('ci_room').value;
  if(isRoomFull(roomId)) { toast(getRoomName(roomId)+' is already at full capacity!','err'); return false; }
  var data = {
    id:nextId('checkin'), name:document.getElementById('ci_name').value.trim(),
    phone:document.getElementById('ci_phone').value.trim(), institution:document.getElementById('ci_institution').value.trim(),
    idNumber:document.getElementById('ci_id').value.trim(), room:roomId,
    date:document.getElementById('ci_date').value, status:document.getElementById('ci_status').value,
    deposit:document.getElementById('ci_deposit').value, notes:document.getElementById('ci_notes').value.trim(),
    createdAt:now()
  };
  DB.checkins.push(data);
  var existing = DB.residents.find(function(r){return r.idNumber===data.idNumber;});
  if(!existing) {
    DB.residents.push({
      id:nextId('resident'), name:data.name, phone:data.phone, institution:data.institution,
      idNumber:data.idNumber, room:data.room, status:data.status, checkinDate:data.date,
      paymentStatus:data.deposit, notes:data.notes, createdAt:now()
    });
  } else {
    existing.room=data.room; existing.phone=data.phone;
    existing.checkinDate=data.date; existing.paymentStatus=data.deposit;
  }
  addActivity('Check-in: '+data.name+' → '+getRoomName(data.room));
  toast('Check-in submitted successfully!');
  syncResidents(); syncCheckins();
  e.target.reset();
  document.getElementById('ci_date').value=new Date().toISOString().split('T')[0];
  return false;
}

function handleRulesAccept(e) {
  e.preventDefault();
  var data = { id:nextId('rules'), name:document.getElementById('ra_name').value.trim(),
    room:document.getElementById('ra_room').value, accepted:true, acceptedAt:now(), version:'Rules v1.0' };
  DB.rulesAcceptance.push(data);
  addActivity('Rules accepted by '+data.name);
  toast('Rules acceptance recorded. Thank you!');
  syncRules();
  e.target.reset();
  return false;
}

function handleMaintenance(e) {
  e.preventDefault();
  var data = { id:nextId('maintenance'), name:document.getElementById('mt_name').value.trim(),
    room:document.getElementById('mt_room').value, category:document.getElementById('mt_category').value,
    urgency:document.getElementById('mt_urgency').value, description:document.getElementById('mt_desc').value.trim(),
    status:'Open', createdAt:now() };
  DB.maintenance.push(data);
  addActivity('Maintenance request from '+data.name+': '+data.category);
  toast('Maintenance request submitted!');
  syncMaintenance();
  e.target.reset();
  return false;
}

function handleIncident(e) {
  e.preventDefault();
  var data = { id:nextId('incident'), submittedBy:document.getElementById('in_name').value.trim(),
    room:document.getElementById('in_room').value, type:document.getElementById('in_type').value,
    urgency:document.getElementById('in_urgency').value, description:document.getElementById('in_desc').value.trim(),
    status:'Open', adminNotes:'', createdAt:now(), closedAt:null };
  DB.incidents.push(data);
  addActivity('Incident reported by '+data.submittedBy+': '+data.type);
  toast('Incident report submitted! Opening WhatsApp...');
  syncIncidents();
  sendWhatsAppIncident(data);
  e.target.reset();
  return false;
}

function handleCheckout(e) {
  e.preventDefault();
  var data = { id:nextId('checkout'), name:document.getElementById('co_name').value.trim(),
    room:document.getElementById('co_room').value, date:document.getElementById('co_date').value,
    keyReturned:document.getElementById('co_key').value,
    condition:document.getElementById('co_condition').value.trim(),
    forwardContact:document.getElementById('co_forward').value.trim(), createdAt:now() };
  DB.checkouts.push(data);
  var res = DB.residents.find(function(r){return r.room===data.room && r.name.toLowerCase()===data.name.toLowerCase();});
  if(res) res.room='';
  addActivity('Check-out: '+data.name+' from '+getRoomName(data.room));
  toast('Check-out submitted successfully!');
  syncResidents(); syncCheckouts();
  e.target.reset();
  return false;
}

/* ===== ADMIN TABS ===== */
function refreshAdminTab(tab) {
  if(tab==='adm-overview') renderOverview();
  else if(tab==='adm-residents') renderResidents();
  else if(tab==='adm-rooms') renderRooms();
  else if(tab==='adm-payments') renderPayments();
  else if(tab==='adm-utilities'){renderPower();renderWater();}
  else if(tab==='adm-incidents') renderIncidents();
  else if(tab==='adm-notices') renderAdminNotices();
}

function renderOverview() {
  var totalOcc = DB.residents.filter(function(r){return r.room;}).length;
  var stats = [
    {n:DB.residents.length, l:'Total Residents', i:'fa-users'},
    {n:totalOcc+'/'+TOTAL_CAPACITY, l:'Beds Occupied', i:'fa-bed'},
    {n:DB.incidents.filter(function(i){return i.status==='Open';}).length, l:'Open Incidents', i:'fa-flag'},
    {n:DB.maintenance.filter(function(m){return m.status==='Open';}).length, l:'Pending Maintenance', i:'fa-wrench'},
    {n:DB.payments.length, l:'Payments Recorded', i:'fa-money-bill'},
    {n:DB.checkins.length, l:'Total Check-Ins', i:'fa-right-to-bracket'}
  ];
  document.getElementById('statsGrid').innerHTML = stats.map(function(s){
    return '<div class="stat-card"><div class="num">'+s.n+'</div><div class="lbl"><i class="fas '+s.i+'"></i> '+s.l+'</div></div>';
  }).join('');

  var log = DB.activity.slice(0,15);
  document.getElementById('activityLog').innerHTML = log.length
    ? log.map(function(a){return '<div style="padding:8px 0;border-bottom:1px solid var(--brd);font-size:.84rem"><span style="color:var(--txt3);font-size:.75rem;margin-right:8px">'+fmtDateTime(a.time)+'</span>'+esc(a.msg)+'</div>';}).join('')
    : '<div class="empty-state"><i class="fas fa-clock"></i><p>No activity yet</p></div>';
}

function renderResidents() {
  var q = (document.getElementById('residentSearch').value||'').toLowerCase();
  var filtered = DB.residents.filter(function(r){return !q||r.name.toLowerCase().indexOf(q)!==-1||getRoomName(r.room).toLowerCase().indexOf(q)!==-1||r.status.toLowerCase().indexOf(q)!==-1;});
  document.getElementById('residentsBody').innerHTML = filtered.length
    ? filtered.map(function(r){return '<tr><td><strong>'+esc(r.name)+'</strong></td><td>'+(r.room?getRoomName(r.room):'-')+'</td><td>'+esc(r.phone)+'</td><td><span class="badge badge-'+(r.status==='New'?'pri':'suc')+'">'+r.status+'</span></td><td><span class="badge badge-'+(r.paymentStatus==='Paid'?'suc':r.paymentStatus==='Pending'?'err':'warn')+'">'+(r.paymentStatus||'-')+'</span></td><td><button class="btn btn-out btn-sm" onclick="removeResident(\''+r.id+'\')"><i class="fas fa-trash"></i></button></td></tr>';}).join('')
    : '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-users"></i><p>No residents found</p></div></td></tr>';
}

function removeResident(id) {
  showConfirm('Remove Resident','Are you sure you want to remove this resident?',function(){
    DB.residents=DB.residents.filter(function(r){return r.id!==id;});
    addActivity('Resident removed');
    syncResidents();
    renderResidents();
    toast('Resident removed');
  });
}

function addResidentManual(e) {
  e.preventDefault();
  var roomId = document.getElementById('ar_room').value;
  if(isRoomFull(roomId)){toast(getRoomName(roomId)+' is at full capacity!','err');return false;}
  DB.residents.push({
    id:nextId('resident'), name:document.getElementById('ar_name').value.trim(),
    phone:document.getElementById('ar_phone').value.trim(), institution:document.getElementById('ar_inst').value.trim(),
    idNumber:document.getElementById('ar_id').value.trim(), room:roomId,
    status:document.getElementById('ar_status').value, checkinDate:new Date().toISOString().split('T')[0],
    paymentStatus:'Pending', notes:'', createdAt:now()
  });
  addActivity('Resident added: '+document.getElementById('ar_name').value.trim()+' → '+getRoomName(roomId));
  closeModal('addResidentModal');
  syncResidents();
  renderResidents();
  toast('Resident added!');
  e.target.reset();
  return false;
}

function renderRooms() {
  var html = '';
  ROOMS.forEach(function(rm){
    var occ = getRoomOccupants(rm.id);
    var cls = occ.length===0?'empty':occ.length>=rm.capacity?'full':'partial';
    html += '<div class="room-cell '+cls+'" onclick="showRoomDetail(\''+rm.id+'\')">';
    html += '<div class="room-name">'+esc(rm.name)+'</div>';
    html += '<div class="room-occ">'+occ.length+' / '+rm.capacity+' beds</div>';
    html += '</div>';
  });
  document.getElementById('roomGrid').innerHTML = html;
}

function showRoomDetail(roomId) {
  var rm = ROOMS.find(function(x){return x.id===roomId;});
  if(!rm) return;
  var occ = getRoomOccupants(roomId);
  document.getElementById('roomDetailTitle').textContent = rm.name+' — '+occ.length+'/'+rm.capacity+' beds';
  var body = '';
  if(occ.length===0) {
    body = '<p style="color:var(--txt3)">No residents currently assigned to this room.</p>';
  } else {
    body = '<div class="tbl-wrap"><table class="tbl"><thead><tr><th>Name</th><th>Phone</th><th>Status</th></tr></thead><tbody>';
    occ.forEach(function(r){
      body += '<tr><td>'+esc(r.name)+'</td><td>'+esc(r.phone)+'</td><td><span class="badge badge-'+(r.paymentStatus==='Paid'?'suc':'warn')+'">'+r.paymentStatus+'</span></td></tr>';
    });
    body += '</tbody></table></div>';
  }
  document.getElementById('roomDetailBody').innerHTML = body;
  document.getElementById('roomDetailCard').style.display = 'block';
}

function renderPayments() {
  var q = (document.getElementById('paymentSearch').value||'').toLowerCase();
  var filtered = DB.payments.filter(function(p){return !q||p.name.toLowerCase().indexOf(q)!==-1||p.method.toLowerCase().indexOf(q)!==-1;});
  document.getElementById('paymentsBody').innerHTML = filtered.length
    ? filtered.map(function(p){return '<tr><td>'+fmtDate(p.paidDate)+'</td><td>'+esc(p.name)+'</td><td>'+esc(p.month)+'</td><td><strong>$'+Number(p.amount).toFixed(2)+'</strong></td><td>$'+Number(p.balance).toFixed(2)+'</td><td>'+esc(p.method)+'</td><td>'+esc(p.ref||'-')+'</td></tr>';}).join('')
    : '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-money-bill"></i><p>No payments recorded</p></div></td></tr>';
}

function addPayment(e) {
  e.preventDefault();
  DB.payments.push({
    id:nextId('payment'), name:document.getElementById('pm_name').value.trim(),
    month:document.getElementById('pm_month').value, amount:document.getElementById('pm_amount').value,
    balance:document.getElementById('pm_balance').value||0, method:document.getElementById('pm_method').value,
    ref:document.getElementById('pm_ref').value.trim(), notes:document.getElementById('pm_notes').value.trim(),
    paidDate:now(), recordedBy:'Admin'
  });
  addActivity('Payment: $'+document.getElementById('pm_amount').value+' from '+document.getElementById('pm_name').value.trim());
  closeModal('addPaymentModal');
  syncPayments();
  renderPayments();
  toast('Payment recorded!');
  e.target.reset();
  return false;
}

function renderPower() {
  document.getElementById('powerBody').innerHTML = DB.power.length
    ? DB.power.map(function(p){return '<tr><td>'+fmtDate(p.date)+'</td><td>'+p.units+'</td><td>$'+Number(p.amount).toFixed(2)+'</td><td>'+(p.balance||'-')+'</td><td>'+esc(p.notes||'-')+'</td></tr>';}).join('')
    : '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-bolt"></i><p>No electricity records</p></div></td></tr>';
}
function renderWater() {
  document.getElementById('waterBody').innerHTML = DB.water.length
    ? DB.water.map(function(w){return '<tr><td>'+fmtDate(w.date)+'</td><td>'+w.litres+'L</td><td>'+esc(w.supplier||'-')+'</td><td>$'+Number(w.cost).toFixed(2)+'</td><td>'+w.filled+'</td><td>'+esc(w.notes||'-')+'</td></tr>';}).join('')
    : '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-droplet"></i><p>No water records</p></div></td></tr>';
}

function addPower(e) {
  e.preventDefault();
  DB.power.push({id:nextId('power'),date:document.getElementById('pw_date').value,units:document.getElementById('pw_units').value,amount:document.getElementById('pw_amount').value,balance:document.getElementById('pw_balance').value,notes:document.getElementById('pw_notes').value.trim()});
  addActivity('Electricity recharge: '+document.getElementById('pw_units').value+' units');
  closeModal('addPowerModal'); syncPower(); renderPower(); toast('Electricity record saved!');
  e.target.reset(); return false;
}
function addWater(e) {
  e.preventDefault();
  DB.water.push({id:nextId('water'),date:document.getElementById('wt_date').value,litres:document.getElementById('wt_litres').value,supplier:document.getElementById('wt_supplier').value.trim(),cost:document.getElementById('wt_cost').value,filled:document.getElementById('wt_filled').value,notes:document.getElementById('wt_notes').value.trim()});
  addActivity('Water delivery: '+document.getElementById('wt_litres').value+'L');
  closeModal('addWaterModal'); syncWater(); renderWater(); toast('Water record saved!');
  e.target.reset(); return false;
}

function switchUtilTab(tab) {
  document.querySelectorAll('.util-tab').forEach(function(t){t.classList.remove('active');});
  document.querySelector('.util-tab[data-util="'+tab+'"]').classList.add('active');
  document.getElementById('util-power').style.display = tab==='power'?'block':'none';
  document.getElementById('util-water').style.display = tab==='water'?'block':'none';
}

function renderIncidents() {
  var q = (document.getElementById('incidentSearch').value||'').toLowerCase();
  var filtered = DB.incidents.filter(function(i){return !q||i.submittedBy.toLowerCase().indexOf(q)!==-1||i.type.toLowerCase().indexOf(q)!==-1||i.status.toLowerCase().indexOf(q)!==-1;});
  document.getElementById('incidentsBody').innerHTML = filtered.length
    ? filtered.map(function(i){return '<tr><td>'+fmtDate(i.createdAt)+'</td><td>'+esc(i.submittedBy)+'</td><td>'+getRoomName(i.room)+'</td><td>'+i.type+'</td><td><span class="badge badge-'+urgBadge(i.urgency)+'">'+i.urgency+'</span></td><td><span class="badge badge-'+statusBadge(i.status)+'">'+i.status+'</span></td><td><button class="btn btn-out btn-sm" onclick="viewIncident(\''+i.id+'\')"><i class="fas fa-eye"></i></button> <button class="btn btn-sm btn-'+(i.status==='Closed'?'out':'pri')+'" onclick="toggleIncident(\''+i.id+'\')">'+(i.status==='Closed'?'Reopen':'Close')+'</button></td></tr>';}).join('')
    : '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-flag"></i><p>No incidents</p></div></td></tr>';
}
function urgBadge(u){return u==='Critical'||u==='High'?'err':u==='Medium'?'warn':'suc';}
function statusBadge(s){return s==='Open'?'err':s==='In Progress'?'warn':'suc';}

function viewIncident(id) {
  var i = DB.incidents.find(function(x){return x.id===id;});
  if(!i) return;
  document.getElementById('incidentDetail').innerHTML = '<div style="font-size:.88rem;line-height:1.8"><p><strong>Reported by:</strong> '+esc(i.submittedBy)+'</p><p><strong>Room:</strong> '+getRoomName(i.room)+'</p><p><strong>Type:</strong> '+i.type+'</p><p><strong>Urgency:</strong> <span class="badge badge-'+urgBadge(i.urgency)+'">'+i.urgency+'</span></p><p><strong>Status:</strong> <span class="badge badge-'+statusBadge(i.status)+'">'+i.status+'</span></p><p><strong>Date:</strong> '+fmtDateTime(i.createdAt)+'</p><p><strong>Description:</strong></p><p style="background:var(--bg2);padding:10px;border-radius:8px">'+esc(i.description)+'</p></div>';
  openModal('viewIncidentModal');
}
function toggleIncident(id) {
  var i = DB.incidents.find(function(x){return x.id===id;});
  if(!i) return;
  if(i.status==='Closed'){i.status='Open';i.closedAt=null;}
  else{i.status='Closed';i.closedAt=now();}
  addActivity('Incident '+i.id+' '+i.status.toLowerCase());
  syncIncidents(); renderIncidents();
  toast('Incident '+i.status.toLowerCase());
}

function renderAdminNotices() {
  document.getElementById('adminNoticesList').innerHTML = DB.notices.length
    ? DB.notices.map(function(n){return '<div class="card notice-card"><div class="notice-date">'+fmtDateTime(n.createdAt)+' <span class="badge badge-'+(n.priority==='Urgent'?'err':n.priority==='Important'?'warn':'pri')+'">'+n.priority+'</span></div><div class="notice-title">'+esc(n.title)+'</div><p style="font-size:.85rem;color:var(--txt2);margin-top:4px">'+esc(n.content)+'</p><button class="btn btn-out btn-sm" style="margin-top:8px" onclick="removeNotice(\''+n.id+'\')"><i class="fas fa-trash"></i> Remove</button></div>';}).join('')
    : '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No notices posted</p></div>';
}

function addNotice(e) {
  e.preventDefault();
  DB.notices.unshift({ id:nextId('notice'), title:document.getElementById('nt_title').value.trim(),
    content:document.getElementById('nt_content').value.trim(),
    priority:document.getElementById('nt_priority').value, createdAt:now() });
  addActivity('Notice posted: '+document.getElementById('nt_title').value.trim());
  closeModal('addNoticeModal'); syncNotices(); renderAdminNotices(); renderResNotices();
  toast('Notice published!');
  e.target.reset(); return false;
}
function removeNotice(id) {
  showConfirm('Remove Notice','Are you sure you want to remove this notice?',function(){
    DB.notices=DB.notices.filter(function(n){return n.id!==id;});
    syncNotices(); renderAdminNotices(); renderResNotices();
    toast('Notice removed');
  });
}

function renderResNotices() {
  document.getElementById('resNoticesList').innerHTML = DB.notices.length
    ? DB.notices.map(function(n){return '<div class="card notice-card fade-in"><div class="notice-date">'+fmtDateTime(n.createdAt)+' <span class="badge badge-'+(n.priority==='Urgent'?'err':n.priority==='Important'?'warn':'pri')+'">'+n.priority+'</span></div><div class="notice-title">'+esc(n.title)+'</div><p style="font-size:.85rem;color:var(--txt2);margin-top:4px">'+esc(n.content)+'</p></div>';}).join('')
    : '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No notices at this time</p></div>';
}

/* ===== SETTINGS ===== */
function updatePin() {
  var v = document.getElementById('settingPin').value;
  if(v.length<6){toast('Password must be at least 6 characters','err');return;}
  if(v.length>12){toast('Password cannot exceed 12 characters','err');return;}
  DB.config.pin = v;
  toast('Password updated successfully');
  addActivity('Admin password changed');
}
function updateGAS() {
  DB.config.gasUrl = document.getElementById('settingGAS').value.trim();
  updateGSStatus(false);
  toast(DB.config.gasUrl?'Google Apps Script URL saved':'URL cleared');
}
function updateSecret() {
  DB.config.gasSecret = document.getElementById('settingSecret').value.trim();
  toast('Secret key saved');
}

/* ===== EXPORT SYSTEM (CSV + PDF) ===== */
function getExportData(type) {
  var result = {title:'',headers:[],rows:[]};
  if(type==='residents') {
    result.title='Residents Register';
    result.headers=['Name','Phone','Institution','ID Number','Room','Status','Payment','Check-In Date'];
    DB.residents.forEach(function(r){result.rows.push([r.name,r.phone,r.institution||'-',r.idNumber,getRoomName(r.room)||'-',r.status,r.paymentStatus||'-',r.checkinDate||'-']);});
  } else if(type==='payments') {
    result.title='Payments Ledger';
    result.headers=['Date','Resident','Month','Amount','Balance','Method','Reference'];
    DB.payments.forEach(function(p){result.rows.push([fmtDate(p.paidDate),p.name,p.month,'$'+Number(p.amount).toFixed(2),'$'+Number(p.balance).toFixed(2),p.method,p.ref||'-']);});
  } else if(type==='incidents') {
    result.title='Incident Reports';
    result.headers=['Date','Reported By','Room','Type','Urgency','Status','Description'];
    DB.incidents.forEach(function(i){result.rows.push([fmtDate(i.createdAt),i.submittedBy,getRoomName(i.room),i.type,i.urgency,i.status,i.description]);});
  } else if(type==='checkins') {
    result.title='Check-In Records';
    result.headers=['Date','Name','Phone','Institution','ID','Room','Status','Deposit'];
    DB.checkins.forEach(function(c){result.rows.push([c.date,c.name,c.phone,c.institution||'-',c.idNumber,getRoomName(c.room),c.status,c.deposit]);});
  } else if(type==='checkouts') {
    result.title='Check-Out Records';
    result.headers=['Date','Name','Room','Key Returned','Condition','Forward Contact'];
    DB.checkouts.forEach(function(c){result.rows.push([c.date,c.name,getRoomName(c.room),c.keyReturned,c.condition||'-',c.forwardContact||'-']);});
  } else if(type==='maintenance') {
    result.title='Maintenance Requests';
    result.headers=['Date','Name','Room','Category','Urgency','Status','Description'];
    DB.maintenance.forEach(function(m){result.rows.push([fmtDate(m.createdAt),m.name,getRoomName(m.room),m.category,m.urgency,m.status,m.description]);});
  } else if(type==='power') {
    result.title='Electricity Records';
    result.headers=['Date','Units','Amount (USD)','Balance After','Notes'];
    DB.power.forEach(function(p){result.rows.push([p.date,p.units,'$'+Number(p.amount).toFixed(2),p.balance||'-',p.notes||'-']);});
  } else if(type==='water') {
    result.title='Water Records';
    result.headers=['Date','Litres','Supplier','Cost (USD)','Tank Filled','Notes'];
    DB.water.forEach(function(w){result.rows.push([w.date,w.litres+'L',w.supplier||'-','$'+Number(w.cost).toFixed(2),w.filled,w.notes||'-']);});
  }
  return result;
}

function downloadCSV(headers, rows, filename) {
  if(rows.length===0){toast('No data to export','warn');return;}
  var all = [headers].concat(rows);
  var csv = all.map(function(r){return r.map(function(c){return '"'+String(c||'').replace(/"/g,'""')+'"';}).join(',');}).join('\n');
  var blob = new Blob([csv],{type:'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
}

function downloadPDF(title, headers, rows, filename) {
  if(rows.length===0){toast('No data to export','warn');return;}
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
  doc.setFontSize(16);
  doc.setTextColor(27,67,50);
  doc.text('ResidentHub - '+title,14,18);
  doc.setFontSize(9);
  doc.setTextColor(120,120,120);
  doc.text('Generated: '+new Date().toLocaleString(),14,24);
  doc.autoTable({
    head:[headers], body:rows, startY:30,
    styles:{fontSize:7.5,cellPadding:2.5},
    headStyles:{fillColor:[27,67,50],textColor:255,fontStyle:'bold'},
    alternateRowStyles:{fillColor:[248,246,240]},
    margin:{left:14,right:14}
  });
  doc.save(filename);
}

function doExport(type, format) {
  if(type==='combined') {
    var allTypes = ['residents','payments','incidents','checkins','checkouts','maintenance','power','water'];
    if(format==='csv') {
      var allRows = [];
      allTypes.forEach(function(t){
        var d = getExportData(t);
        if(d.rows.length>0){
          allRows.push(['=== '+d.title.toUpperCase()+' ===']);
          allRows.push(d.headers);
          d.rows.forEach(function(r){allRows.push(r);});
          allRows.push([]);
        }
      });
      if(allRows.length===0){toast('No data to export','warn');return;}
      var csv = allRows.map(function(r){return r.map(function(c){return '"'+String(c||'').replace(/"/g,'""')+'"';}).join(',');}).join('\n');
      var blob = new Blob([csv],{type:'text/csv'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a'); a.href=url; a.download='combined_report.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      toast('Combined CSV exported!');
    } else {
      var jsPDF = window.jspdf.jsPDF;
      var doc = new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
      doc.setFontSize(20);
      doc.setTextColor(27,67,50);
      doc.text('ResidentHub - Combined Report',14,20);
      doc.setFontSize(9);
      doc.setTextColor(120,120,120);
      doc.text('Generated: '+new Date().toLocaleString(),14,27);
      var startY = 35;
      allTypes.forEach(function(t){
        var d = getExportData(t);
        if(d.rows.length===0) return;
        if(startY>180){doc.addPage();startY=20;}
        doc.setFontSize(12);
        doc.setTextColor(27,67,50);
        doc.text(d.title,14,startY);
        startY+=4;
        doc.autoTable({
          head:[d.headers], body:d.rows, startY:startY,
          styles:{fontSize:7,cellPadding:2},
          headStyles:{fillColor:[27,67,50],textColor:255,fontStyle:'bold'},
          alternateRowStyles:{fillColor:[248,246,240]},
          margin:{left:14,right:14}
        });
        startY = doc.lastAutoTable.finalY + 12;
      });
      doc.save('combined_report.pdf');
      toast('Combined PDF exported!');
    }
    return;
  }
  var data = getExportData(type);
  if(format==='csv') {
    downloadCSV(data.headers, data.rows, type+'_export.csv');
    toast(data.title+' CSV exported!');
  } else {
    downloadPDF(data.title, data.headers, data.rows, type+'_export.pdf');
    toast(data.title+' PDF exported!');
  }
}

/* ===== HELPERS ===== */
function esc(str){var d=document.createElement('div');d.textContent=str||'';return d.innerHTML;}

/* ===== INIT ===== */
document.getElementById('ci_date').value = new Date().toISOString().split('T')[0];
document.getElementById('co_date').value = new Date().toISOString().split('T')[0];
renderResNotices();
updateGSStatus(false);

/* Close modals on overlay click */
document.querySelectorAll('.modal-overlay').forEach(function(m){
  m.addEventListener('click',function(e){if(e.target===m) m.classList.remove('show');});
});
</script>
</body>
</html>
